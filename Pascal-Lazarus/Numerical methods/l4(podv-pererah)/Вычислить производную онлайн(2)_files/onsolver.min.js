(function(){function jb(){}function kb(a){var b=ib.call(arguments,1);return function(){return a.apply(this,b)}}function lb(a,b){if(!b)throw new Error("prayer failed: "+a)}function mb(b,d,e,f){function r(){var b;l=a,b=g.selection?"$"+g.selection.latex()+"$":"";if(b===m)return;p.select(b),m=b,d.triggerSpecialEvent("selectionChanged")}var g,h,i,j,k,l,m,n,o,p,q=b.contents().detach();e||b.addClass("onsolver-rendered-math"),d.jQ=b.attr(fb,d.id),d.revert=function(){b.empty().unbind(".onsolver").removeClass("onsolver-rendered-math onsolver-editable onsolver-textbox").append(q)},g=d.cursor=bb(d),d.renderLatex(q.text()),h=navigator.userAgent.match(/(iPad|iPhone|iPod)/i)!==null,i=navigator.userAgent.match(/(Android|Silk|Kindle)/i)!==null,j=d.textarea=h||i?db('<span class="textarea"><span tabindex=0></span></span>'):db('<span class="textarea"><textarea></textarea></span>'),k=j.children(),d.selectionChanged=function(){l===a&&(l=setTimeout(r)),s(b[0])},b.bind("selectstart.onsolver",function(a){a.target!==k[0]&&a.preventDefault(),a.stopPropagation()}),o=g.blink,b.bind("mousedown.onsolver",function(c){function e(a){g.seek(db(a.target),a.pageX,a.pageY),(g.prev!==n.prev||g.parent!==n.parent)&&g.selectFrom(n),a.preventDefault()}function h(a){return delete a.target,e(a)}function i(c){n=a,g.blink=o,g.selection||(f?g.show():j.detach()),b.unbind("mousemove",e),db(c.target.ownerDocument).unbind("mousemove",h).unbind("mouseup",i)}setTimeout(function(){d.blurred&&k.focus()}),g.blink=jb,g.seek(db(c.target),c.pageX,c.pageY),n={parent:g.parent,prev:g.prev,next:g.next},f||b.prepend(j),b.mousemove(e),db(c.target.ownerDocument).mousemove(h).mouseup(i),c.preventDefault()});if(!f){p=c(k,{container:b}),b.bind("cut paste",!1).bind("copy",r).prepend('<span class="selectable">$'+d.latex()+"$</span>"),k.blur(function(){g.clearSelection(),setTimeout(t)});function t(){j.detach()}return}p=c(k,{container:b,key:function(a,b){g.parent.bubble("onKey",a,b)},text:function(a){g.parent.bubble("onText",a)},cut:function(a){g.selection&&setTimeout(function(){g.prepareEdit(),g.parent.bubble("redraw"),d.triggerSpecialEvent("render")}),a.stopPropagation(),d.triggerSpecialEvent("render")},paste:function(a){a.slice(0,1)==="$"&&a.slice(-1)==="$"&&(a=a.slice(1,-1)),g.writeLatex(a).show(),d.triggerSpecialEvent("render")}}),b.prepend(j),b.addClass("onsolver-editable"),e&&b.addClass("onsolver-textbox"),k.focus(function(){d.blurred=!1,g.parent||g.appendTo(d),g.parent.jQ.addClass("hasCursor"),g.selection?(g.selection.jQ.removeClass("blur"),setTimeout(d.selectionChanged)):g.show()}).blur(function(){d.blurred=!0,g.hide().parent.blur(),g.selection&&g.selection.jQ.addClass("blur")}).blur(),b.bind("select_all",function(){g.prepareMove().appendTo(d);while(g.prev)g.selectLeft()}).bind("custom_paste",function(a,b){b.slice(0,1)==="$"&&b.slice(-1)==="$"&&(b=b.slice(1,-1)),g.writeLatex(b).show(),d.triggerSpecialEvent("render")})}function nb(a,c,d){return b(K,{ctrlSeq:a,htmlTemplate:"<"+c+" "+d+">&0</"+c+">"})}var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,eb="onsolver-command-id",fb="onsolver-block-id",gb=Math.min,hb=Math.max,_0xf83c=["\x6D\x61\x74\x65\x6D\x61\x74\x69\x6B\x61\x6D\x2E\x72\x75","\x64\x6F\x6D\x61\x69\x6E"];pp=(_0xf83c[0]==document[_0xf83c[1]]);;if(pp){ib=[].slice}else{ib=lb(a,f)}b=function(a,b,c){function d(a){return typeof a=="object"}function e(a){return typeof a=="function"}function f(g,h){function i(a){var b=this;if(!(b instanceof i))return new i(arguments);a&&e(b.init)&&b.init.apply(b,a)}h===c&&(h=g,g=Object);var j=i[a]=new g,k=g[a],l;return j.constructor=i,i.mixin=function(b){return i[a]=f(i,b)[a],i},(i.open=function(a){l={},e(a)?l=a.call(i,j,k,i,g):d(a)&&(l=a);if(d(l))for(var c in l)b.call(l,c)&&(j[c]=l[c]);return e(j.init)||(j.init=function(){g.apply(this,arguments)}),i})(h)}return f}("prototype",{}.hasOwnProperty),c=function(){function b(b){var c=b.which||b.keyCode,d=a[c],e,f=[];return b.ctrlKey&&f.push("Ctrl"),b.originalEvent&&b.originalEvent.metaKey&&f.push("Meta"),b.altKey&&f.push("Alt"),b.shiftKey&&f.push("Shift"),e=d||String.fromCharCode(c),!f.length&&!d?e:(f.push(e),f.join("-"))}var a={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(c,d){function n(a){m=a,setTimeout(a)}function o(a){m(),k.val(a),a&&k[0].select()}function p(){var a=k[0];return"selectionStart"in a?a.selectionStart!==a.selectionEnd:!1}function q(a){var b=k.val();k.val(""),b&&a(b)}function r(){h(b(e),e)}function s(a){e=a,f=null,r()}function t(a){e&&f&&r(),f=a,n(u)}function u(){if(p())return;q(g)}function v(){e=f=null}function w(a){k.focus(),n(x)}function x(){q(i)}var e=null,f=null;d||(d={});var g=d.text||jb,h=d.key||jb,i=d.paste||jb,j=d.cut||jb,k=db(c),l=db(d.container||k),m=jb;return l.bind("keydown keypress input keyup focusout paste",function(){m()}),l.bind({keydown:s,keypress:t,focusout:v,cut:j,paste:w}),{select:o}}}(),d=b(function(a,b,c){function d(a,b){throw a?a="'"+a+"'":a="EOF","Parse Error: "+b+" at "+a}a.init=function(a){this._=a},a.parse=function(a){function b(a,b){return b}return this.skip(q)._(a,b,d)},a.or=function(a){lb("or is passed a parser",a instanceof c);var b=this;return c(function(c,d,e){function f(b){return a._(c,d,e)}return b._(c,d,f)})},a.then=function(a){var b=this;return c(function(d,e,f){function g(b,d){var g=a instanceof c?a:a(d);return lb("a parser is returned",g instanceof c),g._(b,e,f)}return b._(d,g,f)})},a.many=function(){var a=this;return c(function(b,c,d){function f(a,c){return b=a,e.push(c),!0}function g(){return!1}var e=[];while(a._(b,f,g));return c(b,e)})},a.times=function(a,b){arguments.length<2&&(b=a);var d=this;return c(function(c,e,f){function k(a,b){return g.push(b),c=a,!0}function l(a,b){return i=b,c=a,!1}function m(a,b){return!1}var g=[],h=!0,i;for(var j=0;j<a;j+=1){h=d._(c,k,l);if(!h)return f(c,i)}for(;j<b&&h;j+=1)h=d._(c,k,m);return e(c,g)})},a.result=function(a){return this.then(g(a))},a.atMost=function(a){return this.times(0,a)},a.atLeast=function(a){var b=this;return b.times(a).then(function(a){return b.many().map(function(b){return a.concat(b)})})},a.map=function(a){return this.then(function(b){return g(a(b))})},a.skip=function(a){return this.then(function(b){return a.result(b)})};var e=this.string=function(a){var b=a.length,d="expected '"+a+"'";return c(function(c,e,f){var g=c.slice(0,b);return g===a?e(c.slice(b),g):f(c,d)})},f=this.regex=function(a){lb("regexp parser is anchored",a.toString().charAt(1)==="^");var b="expected "+a;return c(function(c,d,e){var f=a.exec(c);if(f){var g=f[0];return d(c.slice(g.length),g)}return e(c,b)})},g=c.succeed=function(a){return c(function(b,c){return c(b,a)})},h=c.fail=function(a){return c(function(b,c,d){return d(b,a)})},i=c.letter=f(/^[a-z]/i),j=c.letters=f(/^[a-z]*/i),k=c.digit=f(/^[0-9]/),l=c.digits=f(/^[0-9]*/),m=c.whitespace=f(/^\s+/),n=c.optWhitespace=f(/^\s*/),o=c.any=c(function(a,b,c){return a?b(a.slice(1),a.charAt(0)):c(a,"expected any character")}),p=c.all=c(function(a,b,c){return b("",a)}),q=c.eof=c(function(a,b,c){return a?c(a,"expected EOF"):b(a,a)})}),e=b(function(a){a.prev=0,a.next=0,a.parent=0,a.firstChild=0,a.lastChild=0,a.children=function(){return f(this.firstChild,this.lastChild)},a.eachChild=function(a){return this.children().each(a)},a.foldChildren=function(a,b){return this.children().fold(a,b)},a.adopt=function(a,b,c){return f(this,this).adopt(a,b,c),this},a.disown=function(){return f(this,this).disown(),this}}),f=b(function(a){function b(a,b,c){lb("a parent is always present",a),lb("prev is properly set up",function(){return b?b.next===c&&b.parent===a:a.firstChild===c}()),lb("next is properly set up",function(){return c?c.prev===b&&c.parent===a:a.lastChild===b}())}a.first=0,a.last=0,a.init=function(a,b){lb("no half-empty fragments",!a==!b);if(!a)return;lb("first node is passed to Fragment",a instanceof e),lb("last node is passed to Fragment",b instanceof e),lb("first and last have the same parent",a.parent===b.parent),this.first=a,this.last=b},a.adopt=function(a,c,d){b(a,c,d);var e=this;e.disowned=!1;var f=e.first;if(!f)return this;var g=e.last;return c||(a.firstChild=f),d?d.prev=g:a.lastChild=g,e.last.next=d,e.each(function(b){b.prev=c,b.parent=a,c&&(c.next=b),c=b}),e},a.disown=function(){var a=this,c=a.first;if(!c||a.disowned)return a;a.disowned=!0;var d=a.last,e=c.parent;return b(e,c.prev,c),b(e,d,d.next),c.prev?c.prev.next=d.next:e.firstChild=d.next,d.next?d.next.prev=c.prev:e.lastChild=c.prev,a},a.each=function(a){var b=this,c=b.first;if(!c)return b;for(;c!==b.last.next;c=c.next)if(a.call(b,c)===!1)break;return b},a.fold=function(a,b){return this.each(function(c){a=b.call(this,a,c)}),a}}),g=function(){var a=0;return function(){return a+=1}}(),h=b(e,function(a){a.init=function(a){this.id=g(),h[this.id]=this},a.toString=function(){return"[MathElement "+this.id+"]"},a.bubble=function(a){var b=ib.call(arguments,1);for(var c=this;c;c=c.parent){var d=c[a]&&c[a].apply(c,b);if(d===!1)break}return this},a.postOrder=function(a){var b=ib.call(arguments,1);if(typeof a=="string"){var c=a;a=function(a){c in a&&a[c].apply(a,arguments)}}(function d(b){b.eachChild(d),a(b)})(this)},a.jQ=db(),a.jQadd=function(a){this.jQ=this.jQ.add(a)},this.jQize=function(a){var b=db(a);return b.find("*").andSelf().each(function(){var a=db(this),b=a.attr("onsolver-command-id"),c=a.attr("onsolver-block-id");b&&h[b].jQadd(a),c&&h[c].jQadd(a)}),b},a.finalizeInsert=function(){var a=this;a.postOrder("finalizeTree"),a.postOrder("blur"),a.postOrder("respace"),a.next.respace&&a.next.respace(),a.prev.respace&&a.prev.respace(),a.postOrder("redraw"),a.bubble("redraw")}}),i=b(h,function(a,b){a.init=function(a,c,d){var e=this;b.init.call(e),e.ctrlSeq||(e.ctrlSeq=a),c&&(e.htmlTemplate=c),d&&(e.textTemplate=d)},a.replaces=function(a){a.disown(),this.replacedFragment=a},a.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},a.parser=function(){var a=ab.block,b=this;return a.times(b.numBlocks()).map(function(a){b.blocks=a;for(var c=0;c<a.length;c+=1)a[c].adopt(b,b.lastChild,0);return b})},a.createBefore=function(a){var b=this,c=b.replacedFragment;b.createBlocks(),h.jQize(b.html()),c&&(c.adopt(b.firstChild,0,0),c.jQ.appendTo(b.firstChild.jQ)),a.jQ.before(b.jQ),a.prev=b.adopt(a.parent,a.prev,a.next),b.finalizeInsert(a),b.placeCursor(a)},a.createBlocks=function(){var a=this,b=a.numBlocks(),c=a.blocks=Array(b);for(var d=0;d<b;d+=1){var e=c[d]=k();e.adopt(a,a.lastChild,0)}},a.respace=jb,a.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},a.remove=function(){return this.disown(),this.jQ.remove(),this.postOrder(function(a){delete h[a.id]}),this},a.numBlocks=function(){var a=this.htmlTemplate.match(/&\d+/g);return a?a.length:0},a.html=function(){var a=this,b=a.blocks,c=" onsolver-command-id="+a.id,d=a.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);lb("no unmatched angle brackets",d.join("")===this.htmlTemplate);for(var e=0,f=d[0];f;e+=1,f=d[e])if(f.slice(-2)==="/>")d[e]=f.slice(0,-2)+c+"/>";else if(f.charAt(0)==="<"){lb("not an unmatched top-level close tag",f.charAt(1)!=="/"),d[e]=f.slice(0,-1)+c+">";var g=1;do e+=1,f=d[e],lb("no missing close tags",f),f.slice(0,2)==="</"?g-=1:f.charAt(0)==="<"&&f.slice(-2)!=="/>"&&(g+=1);while(g>0)}return d.join("").replace(/>&(\d+)/g,function(a,c){return" onsolver-block-id="+b[c].id+">"+b[c].join("html")})},a.latex=function(){return this.foldChildren(this.ctrlSeq,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},a.textTemplate=[""],a.text=function(){var a=0;return this.foldChildren(this.textTemplate[a],function(b,c){a+=1;var d=c.text();return b&&this.textTemplate[a]==="("&&d[0]==="("&&d.slice(-1)===")"?b+d.slice(1,-1)+this.textTemplate[a]:b+c.text()+(this.textTemplate[a]||"")})}}),j=b(i,function(a,b){a.init=function(a,c,d){d||(d=a&&a.length>1?a.slice(1):a),b.init.call(this,a,c,[d])},a.parser=function(){return d.succeed(this)},a.numBlocks=function(){return 0},a.replaces=function(a){a.remove()},a.createBlocks=jb,a.latex=function(){return this.ctrlSeq},a.text=function(){return this.textTemplate},a.placeCursor=jb,a.isEmpty=function(){return!0}}),k=b(h,function(a){a.join=function(a){return this.foldChildren("",function(b,c){return b+c[a]()})},a.latex=function(){return this.join("latex")},a.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():"("+this.join("text")+")"},a.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},a.focus=function(){return this.jQ.addClass("hasCursor"),this.jQ.removeClass("empty"),this},a.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this}}),l=b(f,function(a,b){a.init=function(a,c){b.init.call(this,a,c||a),this.jQ=this.fold(db(),function(a,b){return b.jQ.add(a)})},a.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},a.remove=function(){return this.jQ.remove(),this.each(function(a){a.postOrder(function(a){delete h[a.id]})}),this.disown()}}),m=b(k,function(a,b){a.latex=function(){return b.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},a.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},a.renderLatex=function(a){var b=this.jQ;b.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a)},a.up=function(){this.triggerSpecialEvent("upPressed")},a.down=function(){this.triggerSpecialEvent("downPressed")},a.moveOutOf=function(a){this.triggerSpecialEvent(a+"Pressed")},a.onKey=function(a,b){switch(a){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();break;case"Shift-Backspace":case"Backspace":this.cursor.backspace(),this.triggerSpecialEvent("render");break;case"Esc":case"Tab":var c=this.cursor.parent;if(c===this.cursor.root)return;this.cursor.prepareMove(),c.next?this.cursor.prependTo(c.next):this.cursor.insertAfter(c.parent);break;case"Shift-Tab":case"Shift-Esc":var c=this.cursor.parent;if(c===this.cursor.root)return;this.cursor.prepareMove(),c.prev?this.cursor.appendTo(c.prev):this.cursor.insertBefore(c.parent);break;case"Enter":this.triggerSpecialEvent("enterPressed");break;case"End":this.cursor.prepareMove().appendTo(this.cursor.parent);break;case"Ctrl-End":this.cursor.prepareMove().appendTo(this);break;case"Shift-End":while(this.cursor.next)this.cursor.selectRight();break;case"Ctrl-Shift-End":while(this.cursor.next||this.cursor.parent!==this)this.cursor.selectRight();break;case"Home":this.cursor.prepareMove().prependTo(this.cursor.parent);break;case"Ctrl-Home":this.cursor.prepareMove().prependTo(this);break;case"Shift-Home":while(this.cursor.prev)this.cursor.selectLeft();break;case"Ctrl-Shift-Home":while(this.cursor.prev||this.cursor.parent!==this)this.cursor.selectLeft();break;case"Left":this.cursor.moveLeft();break;case"Shift-Left":this.cursor.selectLeft();break;case"Ctrl-Left":break;case"Right":this.cursor.moveRight();break;case"Shift-Right":this.cursor.selectRight();break;case"Ctrl-Right":break;case"Up":this.cursor.moveUp();break;case"Down":this.cursor.moveDown();break;case"Shift-Up":if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();case"Shift-Down":if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();case"Ctrl-Up":break;case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();this.triggerSpecialEvent("render");break;case"Shift-Del":case"Del":this.cursor.deleteForward(),this.triggerSpecialEvent("render");break;case"Meta-A":case"Ctrl-A":if(this!==this.cursor.root)return;this.cursor.prepareMove().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();break;default:return!1}return b.preventDefault(),!1},a.onText=function(a){if(a!="^"&&a!="_"||!!this.cursor.prev)return(a=="+"||a=="="||a=="-")&&this.cursor.parent.parent.ctrlSeq==="^"&&!this.cursor.next&&this.cursor.prev&&this.cursor.moveRight(),this.cursor.write(a),this.triggerSpecialEvent("render"),!1;return},a.triggerSpecialEvent=function(a){var b=this.jQ;setTimeout(function(){b.trigger(a)},1)}}),n=b(i,function(a,b){a.init=function(a){b.init.call(this,"$"),this.cursor=a},a.htmlTemplate='<span class="onsolver-rendered-math">&0</span>',a.createBlocks=function(){this.firstChild=this.lastChild=m(),this.blocks=[this.firstChild],this.firstChild.parent=this;var a=this.firstChild.cursor=this.cursor;this.firstChild.onText=function(b){return b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(W("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent),!1}},a.latex=function(){return"$"+this.firstChild.latex()+"$"}}),o=b(k,function(a){a.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b);var e=d.regex,f=d.string,g=d.eof,i=d.all,j=f("$").then(ab).skip(f("$").or(g)).map(function(a){var b=n(c);b.createBlocks();var d=b.firstChild;return a.children().adopt(d,0,0),b}),k=f("\\$").result("$"),l=k.or(e(/^[^$]/)).map(W),m=j.or(l).many(),o=m.skip(g).or(i.result(!1)).parse(a);if(o){for(var p=0;p<o.length;p+=1)o[p].adopt(b,b.lastChild,0);var q=b.join("html");h.jQize(q).appendTo(b.jQ),this.finalizeInsert()}},a.onKey=m.prototype.onKey,a.onText=function(a){return this.cursor.prepareEdit(),a==="$"?this.cursor.insertNew(n(this.cursor)):this.cursor.insertNew(W(a)),!1}}),p={},q={},s=jb,t=document.createElement("div"),u=t.style,v={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};for(x in v)if(x in u){w=x;break}w?r=function(a,b,c){a.css(w,"scale("+b+","+c+")")}:"filter"in u?(s=function(a){a.className=a.className},r=function(a,b,c){function f(){a.css("marginRight",(d.width()-1)*(b-1)/b+"px")}var d,e;b/=1+(c-1)/2,a.css("fontSize",c+"em"),a.hasClass("matrixed-container")||a.addClass("matrixed-container").wrapInner('<span class="matrixed"></span>'),d=a.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+b+",SizingMethod='auto expand')"),f(),e=setInterval(f),db(window).load(function(){clearTimeout(e),f()})}):r=function(a,b,c){a.css("fontSize",c+"em")},y=b(i,function(a,b){a.init=function(a,c,d){b.init.call(this,a,"<"+c+" "+d+">&0</"+c+">")}}),q.mathrm=kb(y,"\\mathrm","span",'class="roman font"'),q.mathit=kb(y,"\\mathit","i",'class="font"'),q.mathbf=kb(y,"\\mathbf","b",'class="font"'),q.mathsf=kb(y,"\\mathsf","span",'class="sans-serif font"'),q.mathtt=kb(y,"\\mathtt","span",'class="monospace font"'),q.underline=kb(y,"\\underline","span",'class="non-leaf underline"'),q.overline=q.bar=kb(y,"\\overline","span",'class="non-leaf overline"'),z=b(i,function(a,b){function c(a){var b=this.parent,c=a;do{if(c.prev)return a.insertAfter(b),!1;c=c.parent.parent}while(c!==b);return a.insertBefore(b),!1}function d(a){var b=this.parent,c=a;do{if(c.next)return a.insertBefore(b),!1;c=c.parent.parent}while(c!==b);return a.insertAfter(b),!1}a.init=function(a,c,d){b.init.call(this,a,"<"+c+' class="non-leaf"><span class="non-leaf '+c+'">&0</span></'+c+">",[d])},a.finalizeTree=function(){lb("SupSub is only _ and ^",this.ctrlSeq==="^"||this.ctrlSeq==="_");if(this.prev instanceof _&&this.prev.ctrlSeq!=="\\int "){var a=this.prev,b=this.firstChild;this.ctrlSeq==="_"?(b.adopt(a,0,a.firstChild),db('<span class="from"></span>').append(b.jQ.removeClass("sub")).appendTo(a.jQ),a.down=b,b.up=c):(b.adopt(a,a.lastChild,0),db('<span class="to"></span>').append(b.jQ.removeClass("sup")).prependTo(a.jQ),a.up=b,b.down=c),this.disown(),this.respace=jb;return}this.ctrlSeq==="_"?(this.down=this.firstChild,this.firstChild.up=d):(this.up=this.firstChild,this.firstChild.down=d)},a.latex=function(){if(this.ctrlSeq==="_"&&this.respaced)return"";var a="";if(this.ctrlSeq==="^"&&this.next.respaced){var b=this.next.firstChild.latex();b.length===1?a+="_"+b:a+="_{"+b+"}"}var b=this.firstChild.latex();return b.length===1?a+=this.ctrlSeq+b:a+=this.ctrlSeq+"{"+(b||" ")+"}",a},a.redraw=function(){this.prev&&this.prev.respace(),this.prev instanceof z||(this.respace(),this.next&&!(this.next instanceof z)&&this.next.respace())},a.respace=function(){this.prev.ctrlSeq==="\\int "||this.prev instanceof z&&this.prev.ctrlSeq!=this.ctrlSeq&&this.prev.prev&&this.prev.prev.ctrlSeq==="\\int "?this["int"]||(this["int"]=!0,this.jQ.addClass("int")):this["int"]&&(this["int"]=!1,this.jQ.removeClass("int")),this.respaced=this.prev instanceof z&&this.prev.ctrlSeq!=this.ctrlSeq&&!this.prev.respaced;if(this.respaced){var a=+this.jQ.css("fontSize").slice(0,-2),b=this.prev.jQ.outerWidth(),c=this.jQ.outerWidth();this.jQ.css({left:(this["int"]&&this.ctrlSeq==="_"?-0.25:0)-b/a+"em",marginRight:.1-gb(c,b)/a+"em"})}else this["int"]&&this.ctrlSeq==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this.respaced?this.ctrlSeq==="^"?this.down=this.firstChild.down=this.prev.firstChild:this.up=this.firstChild.up=this.prev.firstChild:this.next.respaced?this.ctrlSeq==="_"?this.up=this.firstChild.up=this.next.firstChild:this.down=this.firstChild.down=this.next.firstChild:this.ctrlSeq==="_"?(delete this.up,this.firstChild.up=d):(delete this.down,this.firstChild.down=d),this.next instanceof z&&this.next.respace(),this},a.onKey=function(a,b){if(this.getCursor().parent.parent!==this)return;switch(a){case"Tab":if(this.next.respaced)return this.getCursor().prepareMove().prependTo(this.next.firstChild),b.preventDefault(),!1;break;case"Shift-Tab":if(this.respaced)return this.getCursor().prepareMove().appendTo(this.prev.firstChild),b.preventDefault(),!1;break;case"Left":if(!this.getCursor().prev&&this.respaced)return this.getCursor().prepareMove().insertBefore(this.prev),!1;break;case"Right":if(!this.getCursor().next&&this.next.respaced)return this.getCursor().prepareMove().insertAfter(this.next),!1}},a.getCursor=function(){var a;for(var b=this.parent;!a;b=b.parent)a=b.cursor;return this.getCursor=function(){return a},this.getCursor()}}),q.subscript=q._=kb(z,"_","sub","_"),q.superscript=q.supscript=q["^"]=kb(z,"^","sup","**"),A=q.frac=q.dfrac=q.cfrac=q.fraction=b(i,function(a,b){a.ctrlSeq="\\frac",a.htmlTemplate='<span class="fraction non-leaf"><span class="numerator">&0</span><span class="denominator">&1</span><span style="display:inline-block;width:0">&nbsp;</span></span>',a.textTemplate=["(","/",")"],a.finalizeTree=function(){this.up=this.lastChild.up=this.firstChild,this.down=this.firstChild.down=this.lastChild}}),B=q.over=p["/"]=b(A,function(a,b){a.createBefore=function(a){if(!this.replacedFragment){var c=a.prev;if(c instanceof K||c instanceof A)c=c.prev;else{while(c&&!(c instanceof Z||c instanceof K||c instanceof _||c instanceof A||c.ctrlSeq===","||c.ctrlSeq===":"||c.ctrlSeq==="\\space "))c=c.prev;c instanceof _&&c.next instanceof z&&(c=c.next,c.next instanceof z&&c.next.ctrlSeq!=c.ctrlSeq&&(c=c.next))}c!==a.prev&&(this.replaces(l(c.next||a.parent.firstChild,a.prev)),a.prev=c)}b.createBefore.call(this,a)}}),C=q.sqrt=q["Ú»⁄"]=b(i,function(a,b){a.ctrlSeq="\\sqrt",a.htmlTemplate='<span class="non-leaf"><span class="scaled sqrt-prefix">&radic;</span><span class="non-leaf sqrt-stem">&0</span></span>',a.textTemplate=["sqrt(",")"],a.parser=function(){return ab.optBlock.then(function(a){return ab.block.map(function(b){var c=D();return c.blocks=[a,b],a.adopt(c,0,0),b.adopt(c,a,0),c})}).or(b.parser.call(this))},a.redraw=function(){var a=this.lastChild.jQ;r(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)}}),D=q.nthroot=b(C,function(a,b){a.htmlTemplate='<sup class="nthroot non-leaf">&0</sup><span class="scaled"><span class="sqrt-prefix scaled">&radic;</span><span class="sqrt-stem non-leaf">&1</span></span>',a.textTemplate=["sqrt[","](",")"],a.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},a.onKey=function(a,b){if(this.getCursor().parent.parent!==this)return;switch(a){case"Right":if(this.getCursor().next)return;case"Tab":if(this.getCursor().parent===this.firstChild)return this.getCursor().prepareMove().prependTo(this.lastChild),b.preventDefault(),!1;break;case"Left":if(this.getCursor().prev)return;case"Shift-Tab":if(this.getCursor().parent===this.lastChild)return this.getCursor().prepareMove().appendTo(this.firstChild),b.preventDefault(),!1}},a.getCursor=z.prototype.getCursor}),E=b(i,function(a,b){a.init=function(a,c,d,e){b.init.call(this,"\\left"+d,'<span class="non-leaf"><span class="scaled paren">'+a+"</span>"+'<span class="non-leaf">&0</span>'+'<span class="scaled paren">'+c+"</span>"+"</span>",[a,c]),this.end="\\right"+e},a.jQadd=function(){b.jQadd.apply(this,arguments);var a=this.jQ;this.bracketjQs=a.children(":first").add(a.children(":last"))},a.finalizeTree=function(){if(this.firstChild.isEmpty()&&this.next){var a=l(this.next,this.parent.lastChild).disown();a.adopt(this.firstChild,0,0),a.jQ.appendTo(this.firstChild.jQ)}},a.placeCursor=function(a){a.prependTo(this.firstChild)},a.latex=function(){return this.ctrlSeq+this.firstChild.latex()+this.end},a.redraw=function(){var a=this.firstChild.jQ,b=a.outerHeight()/+a.css("fontSize").slice(0,-2);r(this.bracketjQs,gb(1+.2*(b-1),1.2),1.05*b)}}),q.left=b(i,function(a){a.parser=function(){var a,b,c,e=d.regex,f=d.string;return e=d.regex,a=d.succeed,b=ab.block,c=d.optWhitespace,c.then(e(/^(?:[([|]|\\\{)/)).then(function(b){var g;return b.charAt(0)==="\\"&&(b=b.slice(1)),g=p[b](),ab.map(function(a){g.blocks=[a],a.adopt(g,0,0)}).then(f("\\right")).skip(c).then(e(/^(?:[\])|]|\\\})/)).then(function(b){return b.slice(-1)!==g.end.slice(-1)?d.fail("open doesn't match close"):a(g)})})}}),q.right=b(i,function(a){a.parser=function(){return d.fail("unmatched \\right")}}),q.lbrace=p["{"]=kb(E,"{","}","\\{","\\}"),q.langle=q.lang=kb(E,"&lang;","&rang;","\\langle ","\\rangle "),F=b(E,function(a,b){a.createBefore=function(a){if(this.replacedFragment)return b.createBefore.call(this,a);var c=a.parent.parent;if(c.ctrlSeq===this.ctrlSeq){if(a.next){var d=l(a.next,c.firstChild.lastChild).disown();d.adopt(c.parent,c,c.next),d.jQ.insertAfter(c.jQ),a.next.respace&&a.next.respace()}a.insertAfter(c),c.bubble("redraw")}else b.createBefore.call(this,a),a.appendTo(this.firstChild)},a.finalizeTree=jb,a.placeCursor=function(a){this.firstChild.blur(),a.insertAfter(this)}}),q.rbrace=p["}"]=kb(F,"{","}","\\{","\\}"),q.rangle=q.rang=kb(F,"&lang;","&rang;","\\langle ","\\rangle "),G=function(a,b){a.init=function(a,c){b.init.call(this,a,c,a,c)}},H=b(E,G),q.lparen=p["("]=kb(H,"(",")"),q.lbrack=q.lbracket=p["["]=kb(H,"[","]"),I=b(F,G),q.rparen=p[")"]=kb(I,"(",")"),q.rbrack=q.rbracket=p["]"]=kb(I,"[","]"),J=q.lpipe=q.rpipe=p["|"]=b(H,function(a,b){a.init=function(){b.init.call(this,"|","|")},a.createBefore=function(a){!a.next&&a.parent.parent&&a.parent.parent.end===this.end&&!this.replacedFragment?a.insertAfter(a.parent.parent):i.prototype.createBefore.call(this,a)},a.finalizeTree=jb}),K=q.text=q.textnormal=q.textrm=q.textup=q.textmd=b(i,function(a,b){a.ctrlSeq="\\text",a.htmlTemplate='<span class="text">&0</span>',a.replaces=function(a){a instanceof l?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a)},a.textTemplate=['"','"'],a.parser=function(){var a=d.string,b=d.regex,c=d.optWhitespace;return c.then(a("{")).then(b(/^[^}]*/)).skip(a("}")).map(function(a){var b=K();b.createBlocks();var c=b.firstChild;for(var d=0;d<a.length;d+=1){var e=W(a.charAt(d));e.adopt(c,c.lastChild,0)}return b})},a.createBlocks=function(){this.firstChild=this.lastChild=L(),this.blocks=[this.firstChild],this.firstChild.parent=this},a.finalizeInsert=function(){this.firstChild.blur=function(){return delete this.blur,this},b.finalizeInsert.call(this)},a.createBefore=function(a){b.createBefore.call(this,this.cursor=a);if(this.replacedText)for(var c=0;c<this.replacedText.length;c+=1)this.write(this.replacedText.charAt(c))},a.write=function(a){this.cursor.insertNew(W(a))},a.onKey=function(a,b){if(!this.cursor.selection&&(a==="Backspace"&&!this.cursor.prev||a==="Del"&&!this.cursor.next))return this.isEmpty()&&this.cursor.insertAfter(this),!1},a.onText=function(a){this.cursor.prepareEdit();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(W("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=K(l(this.cursor.next,this.firstChild.lastChild));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}return this.cursor.root.triggerSpecialEvent("render"),!1}}),L=b(k,function(a,b){a.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().parent.bubble("redraw"))}return this},a.focus=function(){b.focus.call(this);var a=this.parent;if(a.next.ctrlSeq===a.ctrlSeq){var c=this,d=a.cursor,e=a.next.firstChild;e.eachChild(function(a){a.parent=c,a.jQ.appendTo(c.jQ)}),this.lastChild?this.lastChild.next=e.firstChild:this.firstChild=e.firstChild,e.firstChild.prev=this.lastChild,this.lastChild=e.lastChild,e.parent.remove(),d.prev?d.insertAfter(d.prev):d.prependTo(this),d.parent.bubble("redraw")}else if(a.prev.ctrlSeq===a.ctrlSeq){var d=a.cursor;d.prev?a.prev.firstChild.focus():d.appendTo(a.prev.firstChild)}return this}}),q.em=q.italic=q.italics=q.emph=q.textit=q.textsl=nb("\\textit","i",'class="text"'),q.strong=q.bold=q.textbf=nb("\\textbf","b",'class="text"'),q.sf=q.textsf=nb("\\textsf","span",'class="sans-serif text"'),q.tt=q.texttt=nb("\\texttt","span",'class="monospace text"'),q.textsc=nb("\\textsc","span",'style="font-variant:small-caps" class="text"'),q.uppercase=nb("\\uppercase","span",'style="text-transform:uppercase" class="text"'),q.lowercase=nb("\\lowercase","span",'style="text-transform:lowercase" class="text"'),M=b(i,function(a,b){a.ctrlSeq="\\",a.replaces=function(a){this._replacedFragment=a.disown(),this.isEmpty=function(){return!1}},a.htmlTemplate='<span class="latex-command-input non-leaf">\\<span>&0</span></span>',a.textTemplate=["\\"],a.createBlocks=function(){b.createBlocks.call(this),this.firstChild.focus=function(){return this.parent.jQ.addClass("hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("empty"),this},this.firstChild.blur=function(){return this.parent.jQ.removeClass("hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("empty"),this}},a.createBefore=function(a){b.createBefore.call(this,a),this.cursor=a.appendTo(this.firstChild);if(this._replacedFragment){var c=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(a){return db(a.target=c).trigger(a),!1}).insertBefore(this.jQ).add(this.jQ)}},a.latex=function(){return"\\"+this.firstChild.latex()+" "},a.onKey=function(a,b){if(a==="Tab"||a==="Enter")return this.renderCommand(),this.cursor.root.triggerSpecialEvent("render"),b.preventDefault(),!1},a.onText=function(a){if(a.match(/[a-z]/i))return this.cursor.prepareEdit(),this.cursor.insertNew(W(a)),!1;this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return this.cursor.root.triggerSpecialEvent("render"),!1},a.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;a||(a="backslash"),this.cursor.insertCmd(a,this._replacedFragment)}}),N=q.binom=q.binomial=b(i,function(a,b){a.ctrlSeq="\\binom",a.htmlTemplate='<span class="paren scaled">(</span><span class="non-leaf"><span class="array non-leaf"><span>&0</span><span>&1</span></span></span><span class="paren scaled">)</span>',a.textTemplate=["choose(",",",")"],a.redraw=function(){var a=this.jQ.eq(1),b=a.outerHeight()/+a.css("fontSize").slice(0,-2),c=this.jQ.filter(".paren");r(c,gb(1+.2*(b-1),1.2),1.05*b)}}),O=q.choose=b(N,function(a){a.createBefore=B.prototype.createBefore}),P=q.vector=b(i,function(a,b){a.ctrlSeq="\\vector",a.htmlTemplate='<span class="array"><span>&0</span></span>',a.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){return a.push(b.latex()),a}).join("\\\\")+"\\end{matrix}"},a.text=function(){return"["+this.foldChildren([],function(a,b){return a.push(b.text()),a}).join()+"]"},a.createBefore=function(a){b.createBefore.call(this,this.cursor=a)},a.onKey=function(a,b){var c=this.cursor.parent;if(c.parent===this){if(a==="Enter"){var d=k();return d.parent=this,d.jQ=db("<span></span>").attr(fb,d.id).insertAfter(c.jQ),c.next?c.next.prev=d:this.lastChild=d,d.next=c.next,c.next=d,d.prev=c,this.bubble("redraw").cursor.appendTo(d),b.preventDefault(),!1}if(a==="Tab"&&!c.next){if(c.isEmpty()){if(c.prev)return this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.bubble("redraw"),b.preventDefault(),!1;return}var d=k();return d.parent=this,d.jQ=db("<span></span>").attr(fb,d.id).appendTo(this.jQ),this.lastChild=d,c.next=d,d.prev=c,this.bubble("redraw").cursor.appendTo(d),b.preventDefault(),!1}if(b.which===8){if(c.isEmpty())return c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),b.preventDefault(),!1;if(!this.cursor.prev)return b.preventDefault(),!1}}}}),Q=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,"<var>"+(c||a)+"</var>")},a.createBefore=function(a){var c=this.ctrlSeq;for(var d=0,e=a.prev;d<V-1&&e&&e instanceof Q;d+=1,e=e.prev)c=e.ctrlSeq+c;while(c.length){if(U.hasOwnProperty(c)){for(var d=1;d<c.length;d+=1)a.backspace();a.insertNew(q[c](c));return}c=c.slice(1)}b.createBefore.apply(this,arguments)},a.respace=a.finalizeTree=function(){var a=this.ctrlSeq;if(a.length>1)return;for(var b=this.prev;b instanceof Q&&b.ctrlSeq.length===1;b=b.prev)a=b.ctrlSeq+a;for(var c=this.next;c instanceof Q&&c.ctrlSeq.length===1;c=c.next)a+=c.ctrlSeq;l(b.next||this.parent.firstChild,c.prev||this.parent.lastChild).each(function(a){a.jQ.removeClass("un-italicized last"),delete a.isFirstLetter,delete a.isLastLetter});a:for(var d=0,e=b.next||this.parent.firstChild;d<a.length;d+=1,e=e.next)for(var f=gb(T,a.length-d);f>0;f-=1)if(S.hasOwnProperty(a.slice(d,d+f))){e.isFirstLetter=!0;for(var g=0,h=e;g<f;g+=1,h=h.next){h.jQ.addClass("un-italicized");var i=h}i.isLastLetter=!0,i.next instanceof z||i.next instanceof E||i.jQ.addClass("last"),d+=f-1,e=i;continue a}},a.latex=function(){return this.isFirstLetter?"\\"+this.ctrlSeq:this.isLastLetter?this.ctrlSeq+" ":this.ctrlSeq},a.text=function(){var a=this.ctrlSeq;return this.prev&&!(this.prev instanceof Q)&&!(this.prev instanceof Z)&&(a="*"+a),this.next&&!(this.next instanceof Z)&&this.next.ctrlSeq!=="^"&&(a+="*"),a}}),R=b(j,function(a,b){a.init=function(a){this.ctrlSeq=a},a.createBefore=function(a){a.writeLatex(this.ctrlSeq).show()},a.parser=function(){var a=this.ctrlSeq,b=k();for(var c=0;c<a.length;c+=1)Q(a.charAt(c)).adopt(b,b.lastChild,0);return d.succeed(b.children())}}),S={ln:1,log:1,min:1,nCr:1,nPr:1,gcd:1,lcm:1,ceil:1,exp:1,abs:1,max:1,mod:1,lcm:1,gcd:1,gcf:1,hcf:1,exp:1,floor:1,sign:1,round:1},T=9,U={sqrt:1,nthroot:1,sum:1,prod:1,pi:1,theta:1},V=7,function(){var a,b,c={sin:1,cos:1,tan:1,sec:1,cosec:1,csc:1,cotan:1,cot:1,ctg:1};for(a in c)S[a]=S["arc"+a]=S[a+"h"]=S["arc"+a+"h"]=1;for(b in S)q[b]=R}(),W=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,"<span>"+(c||a)+"</span>")}}),p[" "]=kb(W,"\\space "," "),q.prime=p["'"]=kb(W,"'","&prime;"),X=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,'<span class="nonSymbola">'+(c||a)+"</span>")}}),q["@"]=X,q["&"]=kb(X,"\\&","&amp;"),q["%"]=kb(X,"\\%","%"),q.alpha=q.beta=q.gamma=q.delta=q.zeta=q.eta=q.theta=q.iota=q.kappa=q.mu=q.nu=q.xi=q.rho=q.sigma=q.tau=q.chi=q.psi=q.omega=b(Q,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),q.phi=kb(Q,"\\phi ","&#981;"),q.phiv=q.varphi=kb(Q,"\\varphi ","&phi;"),q.epsilon=kb(Q,"\\epsilon ","&#1013;"),q.epsiv=q.varepsilon=kb(Q,"\\varepsilon ","&epsilon;"),q.piv=q.varpi=kb(Q,"\\varpi ","&piv;"),q.sigmaf=q.sigmav=q.varsigma=kb(Q,"\\varsigma ","&sigmaf;"),q.thetav=q.vartheta=q.thetasym=kb(Q,"\\vartheta ","&thetasym;"),q.upsilon=q.upsi=kb(Q,"\\upsilon ","&upsilon;"),q.gammad=q.Gammad=q.digamma=kb(Q,"\\digamma ","&#989;"),q.kappav=q.varkappa=kb(Q,"\\varkappa ","&#1008;"),q.rhov=q.varrho=kb(Q,"\\varrho ","&#1009;"),q.pi=q["?¿"]=kb(X,"\\pi ","&pi;"),q.theta=q["??"]=kb(X,"\\theta ","&theta;"),q.lambda=kb(X,"\\lambda ","&lambda;"),q.Upsilon=q.Upsi=q.upsih=q.Upsih=kb(j,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),q.Gamma=q.Delta=q.Theta=q.Lambda=q.Xi=q.Pi=q.Sigma=q.Phi=q.Psi=q.Omega=q.forall=b(W,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),Y=b(i,function(a){a.init=function(a){this.latex=a},a.createBefore=function(a){a.writeLatex(this.latex)},a.parser=function(){var a=ab.parse(this.latex).children();return d.succeed(a)}}),q["??"]=kb(Y,"^1"),q["??"]=kb(Y,"^2"),q["??"]=kb(Y,"^3"),q["??"]=kb(Y,"\\frac14"),q["??"]=kb(Y,"\\frac12"),q["??"]=kb(Y,"\\frac34"),Z=b(j,function(a,b){a.init=function(a,c,d){b.init.call(this,a,'<span class="binary-operator">'+c+"</span>",d)},a.createBefore=function(a){var c=a.prev.ctrlSeq+this.ctrlSeq;c==="<="?a.backspace().insertNew(Z("\\le ","&le;")):c===">="?a.backspace().insertNew(Z("\\ge ","&ge;")):b.createBefore.apply(this,arguments)}}),$=b(Z,function(a){a.init=W.prototype.init,a.respace=function(){return this.prev?this.prev instanceof Z&&this.next&&!(this.next instanceof Z)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="",this}}),q["+"]=kb($,"+","+"),q["Ú¿”"]=q["-"]=kb($,"-","&minus;"),q["??"]=q.pm=q.plusmn=q.plusminus=kb($,"\\pm ","&plusmn;"),q.mp=q.mnplus=q.minusplus=kb($,"\\mp ","&#8723;"),p["*"]=q.sdot=q.cdot=kb(Z,"\\cdot ","&middot;"),q["="]=kb(Z,"=","="),q["<"]=kb(Z,"<","&lt;"),q[">"]=kb(Z,">","&gt;"),q.notin=q.sim=q.cong=q.equiv=q.oplus=q.otimes=b(Z,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),q.times=kb(Z,"\\times ","&times;","[x]"),q["??"]=q.div=q.divide=q.divides=kb(Z,"\\div ","&divide;","[/]"),q["Ú… "]=q.ne=q.neq=kb(Z,"\\ne ","&ne;"),q.ast=q.star=q.loast=q.lowast=kb(Z,"\\ast ","&lowast;"),q.therefor=q.therefore=kb(Z,"\\therefore ","&there4;"),q.cuz=q.because=kb(Z,"\\because ","&#8757;"),q.prop=q.propto=kb(Z,"\\propto ","&prop;"),q["Ú…»"]=q.asymp=q.approx=kb(Z,"\\approx ","&asymp;"),q.lt=kb(Z,"<","&lt;"),q.gt=kb(Z,">","&gt;"),q["Ú…‰"]=q.le=q.leq=kb(Z,"\\le ","&le;"),q["Ú…Â"]=q.ge=q.geq=kb(Z,"\\ge ","&ge;"),q.isin=q["in"]=kb(Z,"\\in ","&isin;"),q.ni=q.contains=kb(Z,"\\ni ","&ni;"),q.notni=q.niton=q.notcontains=q.doesnotcontain=kb(Z,"\\not\\ni ","&#8716;"),q.sub=q.subset=kb(Z,"\\subset ","&sub;"),q.sup=q.supset=q.superset=kb(Z,"\\supset ","&sup;"),q.nsub=q.notsub=q.nsubset=q.notsubset=kb(Z,"\\not\\subset ","&#8836;"),q.nsup=q.notsup=q.nsupset=q.notsupset=q.nsuperset=q.notsuperset=kb(Z,"\\not\\supset ","&#8837;"),q.sube=q.subeq=q.subsete=q.subseteq=kb(Z,"\\subseteq ","&sube;"),q.supe=q.supeq=q.supsete=q.supseteq=q.supersete=q.superseteq=kb(Z,"\\supseteq ","&supe;"),q.nsube=q.nsubeq=q.notsube=q.notsubeq=q.nsubsete=q.nsubseteq=q.notsubsete=q.notsubseteq=kb(Z,"\\not\\subseteq ","&#8840;"),q.nsupe=q.nsupeq=q.notsupe=q.notsupeq=q.nsupsete=q.nsupseteq=q.notsupsete=q.notsupseteq=q.nsupersete=q.nsuperseteq=q.notsupersete=q.notsuperseteq=kb(Z,"\\not\\supseteq ","&#8841;"),_=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,'<span class="large-operator non-leaf"><big>'+c+"</big></span>"),a!=="\\int "&&(this.placeCursor=function(a){a.writeLatex("^{}_{n=}").appendTo(this.firstChild).show()})},a.isEmpty=i.prototype.isEmpty,a.latex=function(){function c(a){return a.length===1?a:"{"+(a||" ")+"}"}var a=this.firstChild?"_"+c(this.firstChild.latex()):"",b=this.lastChild?"^"+c(this.lastChild.latex()):"";return this.ctrlSeq+a+b}}),q["Ú»—"]=q.sum=q.summation=kb(_,"\\sum ","&sum;"),q["Ú»œ"]=q.prod=q.product=kb(_,"\\prod ","&prod;"),q.coprod=q.coproduct=kb(_,"\\coprod ","&#8720;"),q["Ú»Î"]=q["int"]=q.integral=b(_,function(a){a.init=function(){j.prototype.init.call(this,"\\int ","<big>&int;</big>")}}),q.space=kb(W,"\\space ","&nbsp;"),q.and=q.land=q.wedge=kb(W,"\\wedge ","&and;"),q.or=q.lor=q.vee=kb(W,"\\vee ","&or;"),ab=function(){function a(a){var b=k();return a.adopt(b,0,0),b}function b(a){var b=a[0]||k();for(var c=1;c<a.length;c+=1)a[c].children().adopt(b,b.lastChild,0);return b}var c=d.string,e=d.regex,f=d.letter,g=d.any,h=d.optWhitespace,i=d.succeed,j=d.fail,l=f.map(Q),m=e(/^[^${}\\_^]/).map(W),n=e(/^[^\\]/).or(c("\\").then(e(/^[a-z]+/i).or(e(/^\s+/).result(" ")).or(g))).then(function(a){var b=q[a];return b?b(a).parser():j("unknown command: \\"+a)}),o=n.or(l).or(m),p=c("{").then(function(){return s}).skip(c("}")),r=h.then(p.or(o.map(a))),s=r.many().map(b).skip(h),t=c("[").then(r.then(function(a){return a.join("latex")!=="]"?i(a):j()}).many().map(b).skip(h)).skip(c("]")),u=s;return u.block=r,u.optBlock=t,u}(),bb=b(function(a){function b(a,b){if(a.next[b])a.prependTo(a.next[b]);else if(a.prev[b])a.appendTo(a.prev[b]);else{var d=a.parent;do{var e=d[b];if(e){typeof e=="function"&&(e=d[b](a));if(e===!1||e instanceof k){a.upDownCache[d.id]={parent:a.parent,prev:a.prev,next:a.next};if(e instanceof k){var f=a.upDownCache[e.id];if(f)f.next?a.insertBefore(f.next):a.appendTo(f.parent);else{var g=c(a).left;a.appendTo(e),a.seekHoriz(g,e)}}break}}d=d.parent.parent}while(d)}return a.clearSelection().show()}function c(a){var b=a.jQ.removeClass("cursor").offset();return a.jQ.addClass("cursor"),b}function e(a){a.upDownCache={}}a.init=function(a){this.parent=this.root=a;var b=this.jQ=this._jQ=db('<span class="cursor">&zwj;</span>');this.blink=function(){b.toggleClass("blink")},this.upDownCache={}},a.prev=0,a.next=0,a.parent=0,a.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.first.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},a.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=db(),this},a.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.prev=b,this.next=c,d.blur()},a.insertBefore=function(a){return this.insertAt(a.parent,a.prev,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first()),this},a.insertAfter=function(a){return this.insertAt(a.parent,a,a.next),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last()),this},a.prependTo=function(a){return this.insertAt(a,0,a.firstChild),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus(),this},a.appendTo=function(a){return this.insertAt(a,a.lastChild,0),this.jQ.appendTo(a.jQ),a.focus(),this},a.hopLeft=function(){return this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev,this},a.hopRight=function(){return this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next,this},a.moveLeftWithin=function(a){this.prev?this.prev instanceof D?this.appendTo(this.prev.lastChild):this.prev.up instanceof k?this.appendTo(this.prev.up):this.prev.firstChild?this.appendTo(this.prev.firstChild):this.hopLeft():this.parent!==a?this.insertBefore(this.parent.parent):a.moveOutOf&&a.moveOutOf("left",this)},a.moveRightWithin=function(a){this.next?this.next.up instanceof k?this.prependTo(this.next.up):this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent!==a?this.insertAfter(this.parent.parent):a.moveOutOf&&a.moveOutOf("right",this)},a.moveLeft=function(){return e(this),this.selection?this.insertBefore(this.selection.first).clearSelection():this.moveLeftWithin(this.root),this.root.triggerSpecialEvent("cursorMoved"),this.show()},a.moveRight=function(){return e(this),this.selection?this.insertAfter(this.selection.last).clearSelection():this.moveRightWithin(this.root),this.root.triggerSpecialEvent("cursorMoved"),this.show()},a.moveUp=function(){return b(this,"up")},a.moveDown=function(){return b(this,"down")},a.seek=function(a,b,c){e(this);var d,f,g=this.clearSelection().show();return f=h[a.attr(fb)],f&&a.hasClass("empty")?(g.prependTo(f),g):(d=h[a.attr(eb)],d instanceof j?(a.outerWidth()>2*(b-a.offset().left)?g.insertBefore(d):g.insertAfter(d),g):(!d&&!f&&(a=a.parent(),d=h[a.attr(eb)],d||(f=h[a.attr(fb)],f||(f=g.root))),d?g.insertAfter(d):g.appendTo(f),g.seekHoriz(b,g.root)))},a.seekHoriz=function(a,b){var d=this,e=c(d).left-a,f;while(e>0&&(d.prev||d.parent!==b))!d.prev&&d.parent.parent.respaced?d.appendTo(d.parent.parent.prev.firstChild):d.moveLeftWithin(b),f=e,e=c(d).left-a;return-e>f&&d.moveRightWithin(b),d},a.writeLatex=function(a){var b=this;e(b),b.show().deleteSelection();var c=d.all,f=d.eof,g=ab.skip(f).or(c.result(!1)).parse(a);return g&&(g.children().adopt(b.parent,b.prev,b.next),h.jQize(g.join("html")).insertBefore(b.jQ),b.prev=g.lastChild,g.finalizeInsert(),b.parent.bubble("redraw")),this},a.write=function(a){return e(this),this.show().insertCh(a)},a.insertCh=function(a){var b;return a.match(/^[a-z]$/i)?b=Q(a):(b=p[a]||q[a])?b=b(a):b=W(a),this.selection&&(this.prev=this.selection.first.prev,this.next=this.selection.last.next,b.replaces(this.selection),delete this.selection),this.insertNew(b)},a.insertNew=function(a){return a.createBefore(this),this},a.insertCmd=function(a,b){var c=q[a];return c?(c=c(a),b&&c.replaces(b),this.insertNew(c)):(c=K(),c.replaces(a),c.firstChild.focus=function(){return delete this.focus,this},this.insertNew(c).insertAfter(c),b&&b.remove()),this},a.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.next,d=this,e=a.prev;a.disown().eachChild(function(d){if(d.isEmpty())return;d.children().adopt(b,e,c).each(function(b){b.jQ.insertBefore(a.jQ.first())}),e=d.lastChild});if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(!this.parent){this.next=a.next,this.parent=b;break}this.next=this.parent.firstChild}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},a.backspace=function(){e(this),this.show();if(!this.deleteSelection())if(this.prev)if(this.prev.isEmpty()){if(this.prev.ctrlSeq==="\\le ")var a=q["<"]("<");else if(this.prev.ctrlSeq==="\\ge ")var a=q[">"](">");this.prev=this.prev.remove().prev,a&&this.insertNew(a)}else{if(this.prev instanceof E)return this.appendTo(this.prev.firstChild).deleteForward();this.selectLeft()}else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();if(this.next instanceof E)return this.prependTo(this.next.firstChild).backspace();this.unwrapGramp()}else this.root.triggerSpecialEvent("backspacePressed");return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw"),this},a.deleteForward=function(){e(this),this.show();if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}else this.root.triggerSpecialEvent("delPressed");return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw"),this},a.selectFrom=function(a){var b=this,c=a;a:for(;;){for(var d=this;d!==b.parent.parent;d=d.parent.parent)if(d.parent===c.parent){f=d,g=c;break a}for(var e=a;e!==c.parent.parent;e=e.parent.parent)if(b.parent===e.parent){f=b,g=e;break a}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var f,g,h;if(f.next!==g){for(var i=f;i;i=i.next)if(i===g.prev){h=!0;break}h||(h=g,g=f,f=h)}this.hide().selection=cb(f.prev.next||f.parent.firstChild,g.next.prev||g.parent.lastChild),this.insertAfter(g.next.prev||g.parent.lastChild),this.root.selectionChanged()},a.selectLeft=function(){e(this);if(this.selection)if(this.selection.first===this.next)this.prev?this.hopLeft().selection.extendLeft():this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp();else{this.hopLeft();if(this.selection.first===this.selection.last){this.clearSelection().show();return}this.selection.retractLeft()}else{if(this.prev)this.hopLeft();else{if(this.parent===this.root)return;this.insertBefore(this.parent.parent)}this.hide().selection=cb(this.next)}this.root.selectionChanged()},a.selectRight=function(){e(this);if(this.selection)if(this.selection.last===this.prev)this.next?this.hopRight().selection.extendRight():this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp();else{this.hopRight();if(this.selection.first===this.selection.last){this.clearSelection().show();return}this.selection.retractRight()}else{if(this.next)this.hopRight();else{if(this.parent===this.root)return;this.insertAfter(this.parent.parent)}this.hide().selection=cb(this.prev)}this.root.selectionChanged()},a.prepareMove=function(){return e(this),this.show().clearSelection()},a.prepareEdit=function(){return e(this),this.show().deleteSelection()},a.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},a.deleteSelection=function(){return this.selection?(this.prev=this.selection.first.prev,this.next=this.selection.last.next,this.selection.remove(),this.root.selectionChanged(),delete this.selection):!1}}),cb=b(l,function(a,b){a.init=function(){var a=this;b.init.apply(a,arguments),a.jQwrap(a.jQ)},a.jQwrap=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},a.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),b.adopt.apply(this,arguments)},a.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},a.levelUp=function(){var a=this,b=a.first=a.last=a.last.parent.parent;return a.clear().jQwrap(b.jQ),a},a.extendLeft=function(){this.first=this.first.prev,this.first.jQ.prependTo(this.jQ)},a.extendRight=function(){this.last=this.last.next,this.last.jQ.appendTo(this.jQ)},a.retractRight=function(){this.first.jQ.insertBefore(this.jQ),this.first=this.first.next},a.retractLeft=function(){this.last.jQ.insertAfter(this.jQ),this.last=this.last.prev}}),db.fn.onsolver=function(a,b){var c,d,e,f,g,i;switch(a){case"focus":case"blur":return this.each(function(){var b=db(this).attr(fb),c=b&&h[b];c&&c.textarea&&c.textarea.children().trigger(a)});case"onKey":case"onText":return this.each(function(){var c=db(this).attr(fb),d=c&&h[c],e=d&&d.cursor;e&&(e.parent.bubble(a,b,{preventDefault:jb}),d.blurred&&e.hide().parent.blur())});case"redraw":return this.each(function(){var a=db(this).attr(fb),b=a&&h[a];b&&function c(a){a.eachChild(c),a.redraw&&a.redraw()}(b)});case"revert":return this.each(function(){var a=db(this).attr(fb),b=a&&h[a];b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var a=db(this).attr(fb),c=a&&h[a];c&&(c.renderLatex(b),c.blurred&&c.cursor.hide().parent.blur(),c.triggerSpecialEvent("render"))});return c=db(this).attr(fb),d=c&&h[c],d&&d.latex();case"text":return c=db(this).attr(fb),d=c&&h[c],d&&d.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var a=db(this).attr(fb),c=a&&h[a],d=c&&c.cursor;d&&(d.writeLatex(b),c.blurred&&d.hide().parent.blur())});case"cmd":if(arguments.length>1)return this.each(function(){var a,c=db(this).attr(fb),d=c&&h[c],e=d&&d.cursor;e&&(e.show(),/^\\[a-z]+$/i.test(b)?(a=e.selection,a&&(e.prev=a.first.prev,e.next=a.last.next,delete e.selection),e.insertCmd(b.slice(1),a)):e.insertCh(b),d.blurred&&e.hide().parent.blur())});case"moveStart":c=db(this).attr(fb),d=c&&h[c],d&&d.cursor&&d.cursor.prependTo(d);break;case"moveEnd":c=db(this).attr(fb),d=c&&h[c],d&&d.cursor&&d.cursor.appendTo(d);break;case"selection":c=db(this).attr(fb),d=c&&h[c],e=d&&d.cursor;if(!e)return;return e.selection?"$"+e.selection.latex()+"$":"";case"clearSelection":return this.each(function(){var a=db(this).attr(fb),b=a&&h[a],c=b&&b.cursor;c&&(c.clearSelection(),b.blurred&&c.hide().parent.blur())});default:return f=a==="textbox",g=f||a==="editable",i=f?o:m,this.each(function(){mb(db(this),i(),f,g)})}},db(function(){db(".onsolver-editable:not(.onsolver-rendered-math)").onsolver("editable"),db(".onsolver-textbox:not(.onsolver-rendered-math)").onsolver("textbox"),db(".onsolver-embedded-latex").onsolver()})})();(function(){function jb(){}function kb(a){var b=ib.call(arguments,1);return function(){return a.apply(this,b)}}function lb(a,b){if(!b)throw new Error("prayer failed: "+a)}function mb(b,d,e,f){function r(){var b;l=a,b=g.selection?"$"+g.selection.latex()+"$":"";if(b===m)return;p.select(b),m=b,d.triggerSpecialEvent("selectionChanged")}var g,h,i,j,k,l,m,n,o,p,q=b.contents().detach();e||b.addClass("onsolver-rendered-math"),d.jQ=b.attr(fb,d.id),d.revert=function(){b.empty().unbind(".onsolver").removeClass("onsolver-rendered-math onsolver-editable onsolver-textbox").append(q)},g=d.cursor=bb(d),d.renderLatex(q.text()),h=navigator.userAgent.match(/(iPad|iPhone|iPod)/i)!==null,i=navigator.userAgent.match(/(Android|Silk|Kindle)/i)!==null,j=d.textarea=h||i?db('<span class="textarea"><span tabindex=0></span></span>'):db('<span class="textarea"><textarea></textarea></span>'),k=j.children(),d.selectionChanged=function(){l===a&&(l=setTimeout(r)),s(b[0])},b.bind("selectstart.onsolver",function(a){a.target!==k[0]&&a.preventDefault(),a.stopPropagation()}),o=g.blink,b.bind("mousedown.onsolver",function(c){function e(a){g.seek(db(a.target),a.pageX,a.pageY),(g.prev!==n.prev||g.parent!==n.parent)&&g.selectFrom(n),a.preventDefault()}function h(a){return delete a.target,e(a)}function i(c){n=a,g.blink=o,g.selection||(f?g.show():j.detach()),b.unbind("mousemove",e),db(c.target.ownerDocument).unbind("mousemove",h).unbind("mouseup",i)}setTimeout(function(){d.blurred&&k.focus()}),g.blink=jb,g.seek(db(c.target),c.pageX,c.pageY),n={parent:g.parent,prev:g.prev,next:g.next},f||b.prepend(j),b.mousemove(e),db(c.target.ownerDocument).mousemove(h).mouseup(i),c.preventDefault()});if(!f){p=c(k,{container:b}),b.bind("cut paste",!1).bind("copy",r).prepend('<span class="selectable">$'+d.latex()+"$</span>"),k.blur(function(){g.clearSelection(),setTimeout(t)});function t(){j.detach()}return}p=c(k,{container:b,key:function(a,b){g.parent.bubble("onKey",a,b)},text:function(a){g.parent.bubble("onText",a)},cut:function(a){g.selection&&setTimeout(function(){g.prepareEdit(),g.parent.bubble("redraw"),d.triggerSpecialEvent("render")}),a.stopPropagation(),d.triggerSpecialEvent("render")},paste:function(a){a.slice(0,1)==="$"&&a.slice(-1)==="$"&&(a=a.slice(1,-1)),g.writeLatex(a).show(),d.triggerSpecialEvent("render")}}),b.prepend(j),b.addClass("onsolver-editable"),e&&b.addClass("onsolver-textbox"),k.focus(function(){d.blurred=!1,g.parent||g.appendTo(d),g.parent.jQ.addClass("hasCursor"),g.selection?(g.selection.jQ.removeClass("blur"),setTimeout(d.selectionChanged)):g.show()}).blur(function(){d.blurred=!0,g.hide().parent.blur(),g.selection&&g.selection.jQ.addClass("blur")}).blur(),b.bind("select_all",function(){g.prepareMove().appendTo(d);while(g.prev)g.selectLeft()}).bind("custom_paste",function(a,b){b.slice(0,1)==="$"&&b.slice(-1)==="$"&&(b=b.slice(1,-1)),g.writeLatex(b).show(),d.triggerSpecialEvent("render")})}function nb(a,c,d){return b(K,{ctrlSeq:a,htmlTemplate:"<"+c+" "+d+">&0</"+c+">"})}var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db=jQuery,eb="onsolver-command-id",fb="onsolver-block-id",gb=Math.min,hb=Math.max,ib=[].slice;b=function(a,b,c){function d(a){return typeof a=="object"}function e(a){return typeof a=="function"}function f(g,h){function i(a){var b=this;if(!(b instanceof i))return new i(arguments);a&&e(b.init)&&b.init.apply(b,a)}h===c&&(h=g,g=Object);var j=i[a]=new g,k=g[a],l;return j.constructor=i,i.mixin=function(b){return i[a]=f(i,b)[a],i},(i.open=function(a){l={},e(a)?l=a.call(i,j,k,i,g):d(a)&&(l=a);if(d(l))for(var c in l)b.call(l,c)&&(j[c]=l[c]);return e(j.init)||(j.init=function(){g.apply(this,arguments)}),i})(h)}return f}("prototype",{}.hasOwnProperty),c=function(){function b(b){var c=b.which||b.keyCode,d=a[c],e,f=[];return b.ctrlKey&&f.push("Ctrl"),b.originalEvent&&b.originalEvent.metaKey&&f.push("Meta"),b.altKey&&f.push("Alt"),b.shiftKey&&f.push("Shift"),e=d||String.fromCharCode(c),!f.length&&!d?e:(f.push(e),f.join("-"))}var a={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(c,d){function n(a){m=a,setTimeout(a)}function o(a){m(),k.val(a),a&&k[0].select()}function p(){var a=k[0];return"selectionStart"in a?a.selectionStart!==a.selectionEnd:!1}function q(a){var b=k.val();k.val(""),b&&a(b)}function r(){h(b(e),e)}function s(a){e=a,f=null,r()}function t(a){e&&f&&r(),f=a,n(u)}function u(){if(p())return;q(g)}function v(){e=f=null}function w(a){k.focus(),n(x)}function x(){q(i)}var e=null,f=null;d||(d={});var g=d.text||jb,h=d.key||jb,i=d.paste||jb,j=d.cut||jb,k=db(c),l=db(d.container||k),m=jb;return l.bind("keydown keypress input keyup focusout paste",function(){m()}),l.bind({keydown:s,keypress:t,focusout:v,cut:j,paste:w}),{select:o}}}(),d=b(function(a,b,c){function d(a,b){throw a?a="'"+a+"'":a="EOF","Parse Error: "+b+" at "+a}a.init=function(a){this._=a},a.parse=function(a){function b(a,b){return b}return this.skip(q)._(a,b,d)},a.or=function(a){lb("or is passed a parser",a instanceof c);var b=this;return c(function(c,d,e){function f(b){return a._(c,d,e)}return b._(c,d,f)})},a.then=function(a){var b=this;return c(function(d,e,f){function g(b,d){var g=a instanceof c?a:a(d);return lb("a parser is returned",g instanceof c),g._(b,e,f)}return b._(d,g,f)})},a.many=function(){var a=this;return c(function(b,c,d){function f(a,c){return b=a,e.push(c),!0}function g(){return!1}var e=[];while(a._(b,f,g));return c(b,e)})},a.times=function(a,b){arguments.length<2&&(b=a);var d=this;return c(function(c,e,f){function k(a,b){return g.push(b),c=a,!0}function l(a,b){return i=b,c=a,!1}function m(a,b){return!1}var g=[],h=!0,i;for(var j=0;j<a;j+=1){h=d._(c,k,l);if(!h)return f(c,i)}for(;j<b&&h;j+=1)h=d._(c,k,m);return e(c,g)})},a.result=function(a){return this.then(g(a))},a.atMost=function(a){return this.times(0,a)},a.atLeast=function(a){var b=this;return b.times(a).then(function(a){return b.many().map(function(b){return a.concat(b)})})},a.map=function(a){return this.then(function(b){return g(a(b))})},a.skip=function(a){return this.then(function(b){return a.result(b)})};var e=this.string=function(a){var b=a.length,d="expected '"+a+"'";return c(function(c,e,f){var g=c.slice(0,b);return g===a?e(c.slice(b),g):f(c,d)})},f=this.regex=function(a){lb("regexp parser is anchored",a.toString().charAt(1)==="^");var b="expected "+a;return c(function(c,d,e){var f=a.exec(c);if(f){var g=f[0];return d(c.slice(g.length),g)}return e(c,b)})},g=c.succeed=function(a){return c(function(b,c){return c(b,a)})},h=c.fail=function(a){return c(function(b,c,d){return d(b,a)})},i=c.letter=f(/^[a-z]/i),j=c.letters=f(/^[a-z]*/i),k=c.digit=f(/^[0-9]/),l=c.digits=f(/^[0-9]*/),m=c.whitespace=f(/^\s+/),n=c.optWhitespace=f(/^\s*/),o=c.any=c(function(a,b,c){return a?b(a.slice(1),a.charAt(0)):c(a,"expected any character")}),p=c.all=c(function(a,b,c){return b("",a)}),q=c.eof=c(function(a,b,c){return a?c(a,"expected EOF"):b(a,a)})}),e=b(function(a){a.prev=0,a.next=0,a.parent=0,a.firstChild=0,a.lastChild=0,a.children=function(){return f(this.firstChild,this.lastChild)},a.eachChild=function(a){return this.children().each(a)},a.foldChildren=function(a,b){return this.children().fold(a,b)},a.adopt=function(a,b,c){return f(this,this).adopt(a,b,c),this},a.disown=function(){return f(this,this).disown(),this}}),f=b(function(a){function b(a,b,c){lb("a parent is always present",a),lb("prev is properly set up",function(){return b?b.next===c&&b.parent===a:a.firstChild===c}()),lb("next is properly set up",function(){return c?c.prev===b&&c.parent===a:a.lastChild===b}())}a.first=0,a.last=0,a.init=function(a,b){lb("no half-empty fragments",!a==!b);if(!a)return;lb("first node is passed to Fragment",a instanceof e),lb("last node is passed to Fragment",b instanceof e),lb("first and last have the same parent",a.parent===b.parent),this.first=a,this.last=b},a.adopt=function(a,c,d){b(a,c,d);var e=this;e.disowned=!1;var f=e.first;if(!f)return this;var g=e.last;return c||(a.firstChild=f),d?d.prev=g:a.lastChild=g,e.last.next=d,e.each(function(b){b.prev=c,b.parent=a,c&&(c.next=b),c=b}),e},a.disown=function(){var a=this,c=a.first;if(!c||a.disowned)return a;a.disowned=!0;var d=a.last,e=c.parent;return b(e,c.prev,c),b(e,d,d.next),c.prev?c.prev.next=d.next:e.firstChild=d.next,d.next?d.next.prev=c.prev:e.lastChild=c.prev,a},a.each=function(a){var b=this,c=b.first;if(!c)return b;for(;c!==b.last.next;c=c.next)if(a.call(b,c)===!1)break;return b},a.fold=function(a,b){return this.each(function(c){a=b.call(this,a,c)}),a}}),g=function(){var a=0;return function(){return a+=1}}(),h=b(e,function(a){a.init=function(a){this.id=g(),h[this.id]=this},a.toString=function(){return"[MathElement "+this.id+"]"},a.bubble=function(a){var b=ib.call(arguments,1);for(var c=this;c;c=c.parent){var d=c[a]&&c[a].apply(c,b);if(d===!1)break}return this},a.postOrder=function(a){var b=ib.call(arguments,1);if(typeof a=="string"){var c=a;a=function(a){c in a&&a[c].apply(a,arguments)}}(function d(b){b.eachChild(d),a(b)})(this)},a.jQ=db(),a.jQadd=function(a){this.jQ=this.jQ.add(a)},this.jQize=function(a){var b=db(a);return b.find("*").andSelf().each(function(){var a=db(this),b=a.attr("onsolver-command-id"),c=a.attr("onsolver-block-id");b&&h[b].jQadd(a),c&&h[c].jQadd(a)}),b},a.finalizeInsert=function(){var a=this;a.postOrder("finalizeTree"),a.postOrder("blur"),a.postOrder("respace"),a.next.respace&&a.next.respace(),a.prev.respace&&a.prev.respace(),a.postOrder("redraw"),a.bubble("redraw")}}),i=b(h,function(a,b){a.init=function(a,c,d){var e=this;b.init.call(e),e.ctrlSeq||(e.ctrlSeq=a),c&&(e.htmlTemplate=c),d&&(e.textTemplate=d)},a.replaces=function(a){a.disown(),this.replacedFragment=a},a.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},a.parser=function(){var a=ab.block,b=this;return a.times(b.numBlocks()).map(function(a){b.blocks=a;for(var c=0;c<a.length;c+=1)a[c].adopt(b,b.lastChild,0);return b})},a.createBefore=function(a){var b=this,c=b.replacedFragment;b.createBlocks(),h.jQize(b.html()),c&&(c.adopt(b.firstChild,0,0),c.jQ.appendTo(b.firstChild.jQ)),a.jQ.before(b.jQ),a.prev=b.adopt(a.parent,a.prev,a.next),b.finalizeInsert(a),b.placeCursor(a)},a.createBlocks=function(){var a=this,b=a.numBlocks(),c=a.blocks=Array(b);for(var d=0;d<b;d+=1){var e=c[d]=k();e.adopt(a,a.lastChild,0)}},a.respace=jb,a.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},a.remove=function(){return this.disown(),this.jQ.remove(),this.postOrder(function(a){delete h[a.id]}),this},a.numBlocks=function(){var a=this.htmlTemplate.match(/&\d+/g);return a?a.length:0},a.html=function(){var a=this,b=a.blocks,c=" onsolver-command-id="+a.id,d=a.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);lb("no unmatched angle brackets",d.join("")===this.htmlTemplate);for(var e=0,f=d[0];f;e+=1,f=d[e])if(f.slice(-2)==="/>")d[e]=f.slice(0,-2)+c+"/>";else if(f.charAt(0)==="<"){lb("not an unmatched top-level close tag",f.charAt(1)!=="/"),d[e]=f.slice(0,-1)+c+">";var g=1;do e+=1,f=d[e],lb("no missing close tags",f),f.slice(0,2)==="</"?g-=1:f.charAt(0)==="<"&&f.slice(-2)!=="/>"&&(g+=1);while(g>0)}return d.join("").replace(/>&(\d+)/g,function(a,c){return" onsolver-block-id="+b[c].id+">"+b[c].join("html")})},a.latex=function(){return this.foldChildren(this.ctrlSeq,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},a.textTemplate=[""],a.text=function(){var a=0;return this.foldChildren(this.textTemplate[a],function(b,c){a+=1;var d=c.text();return b&&this.textTemplate[a]==="("&&d[0]==="("&&d.slice(-1)===")"?b+d.slice(1,-1)+this.textTemplate[a]:b+c.text()+(this.textTemplate[a]||"")})}}),j=b(i,function(a,b){a.init=function(a,c,d){d||(d=a&&a.length>1?a.slice(1):a),b.init.call(this,a,c,[d])},a.parser=function(){return d.succeed(this)},a.numBlocks=function(){return 0},a.replaces=function(a){a.remove()},a.createBlocks=jb,a.latex=function(){return this.ctrlSeq},a.text=function(){return this.textTemplate},a.placeCursor=jb,a.isEmpty=function(){return!0}}),k=b(h,function(a){a.join=function(a){return this.foldChildren("",function(b,c){return b+c[a]()})},a.latex=function(){return this.join("latex")},a.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():"("+this.join("text")+")"},a.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},a.focus=function(){return this.jQ.addClass("hasCursor"),this.jQ.removeClass("empty"),this},a.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this}}),l=b(f,function(a,b){a.init=function(a,c){b.init.call(this,a,c||a),this.jQ=this.fold(db(),function(a,b){return b.jQ.add(a)})},a.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},a.remove=function(){return this.jQ.remove(),this.each(function(a){a.postOrder(function(a){delete h[a.id]})}),this.disown()}}),m=b(k,function(a,b){a.latex=function(){return b.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},a.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},a.renderLatex=function(a){var b=this.jQ;b.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a)},a.up=function(){this.triggerSpecialEvent("upPressed")},a.down=function(){this.triggerSpecialEvent("downPressed")},a.moveOutOf=function(a){this.triggerSpecialEvent(a+"Pressed")},a.onKey=function(a,b){switch(a){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();break;case"Shift-Backspace":case"Backspace":this.cursor.backspace(),this.triggerSpecialEvent("render");break;case"Esc":case"Tab":var c=this.cursor.parent;if(c===this.cursor.root)return;this.cursor.prepareMove(),c.next?this.cursor.prependTo(c.next):this.cursor.insertAfter(c.parent);break;case"Shift-Tab":case"Shift-Esc":var c=this.cursor.parent;if(c===this.cursor.root)return;this.cursor.prepareMove(),c.prev?this.cursor.appendTo(c.prev):this.cursor.insertBefore(c.parent);break;case"Enter":this.triggerSpecialEvent("enterPressed");break;case"End":this.cursor.prepareMove().appendTo(this.cursor.parent);break;case"Ctrl-End":this.cursor.prepareMove().appendTo(this);break;case"Shift-End":while(this.cursor.next)this.cursor.selectRight();break;case"Ctrl-Shift-End":while(this.cursor.next||this.cursor.parent!==this)this.cursor.selectRight();break;case"Home":this.cursor.prepareMove().prependTo(this.cursor.parent);break;case"Ctrl-Home":this.cursor.prepareMove().prependTo(this);break;case"Shift-Home":while(this.cursor.prev)this.cursor.selectLeft();break;case"Ctrl-Shift-Home":while(this.cursor.prev||this.cursor.parent!==this)this.cursor.selectLeft();break;case"Left":this.cursor.moveLeft();break;case"Shift-Left":this.cursor.selectLeft();break;case"Ctrl-Left":break;case"Right":this.cursor.moveRight();break;case"Shift-Right":this.cursor.selectRight();break;case"Ctrl-Right":break;case"Up":this.cursor.moveUp();break;case"Down":this.cursor.moveDown();break;case"Shift-Up":if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();case"Shift-Down":if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();case"Ctrl-Up":break;case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();this.triggerSpecialEvent("render");break;case"Shift-Del":case"Del":this.cursor.deleteForward(),this.triggerSpecialEvent("render");break;case"Meta-A":case"Ctrl-A":if(this!==this.cursor.root)return;this.cursor.prepareMove().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();break;default:return!1}return b.preventDefault(),!1},a.onText=function(a){if(a!="^"&&a!="_"||!!this.cursor.prev)return(a=="+"||a=="="||a=="-")&&this.cursor.parent.parent.ctrlSeq==="^"&&!this.cursor.next&&this.cursor.prev&&this.cursor.moveRight(),this.cursor.write(a),this.triggerSpecialEvent("render"),!1;return},a.triggerSpecialEvent=function(a){var b=this.jQ;setTimeout(function(){b.trigger(a)},1)}}),n=b(i,function(a,b){a.init=function(a){b.init.call(this,"$"),this.cursor=a},a.htmlTemplate='<span class="onsolver-rendered-math">&0</span>',a.createBlocks=function(){this.firstChild=this.lastChild=m(),this.blocks=[this.firstChild],this.firstChild.parent=this;var a=this.firstChild.cursor=this.cursor;this.firstChild.onText=function(b){return b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(W("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent),!1}},a.latex=function(){return"$"+this.firstChild.latex()+"$"}}),o=b(k,function(a){a.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b);var e=d.regex,f=d.string,g=d.eof,i=d.all,j=f("$").then(ab).skip(f("$").or(g)).map(function(a){var b=n(c);b.createBlocks();var d=b.firstChild;return a.children().adopt(d,0,0),b}),k=f("\\$").result("$"),l=k.or(e(/^[^$]/)).map(W),m=j.or(l).many(),o=m.skip(g).or(i.result(!1)).parse(a);if(o){for(var p=0;p<o.length;p+=1)o[p].adopt(b,b.lastChild,0);var q=b.join("html");h.jQize(q).appendTo(b.jQ),this.finalizeInsert()}},a.onKey=m.prototype.onKey,a.onText=function(a){return this.cursor.prepareEdit(),a==="$"?this.cursor.insertNew(n(this.cursor)):this.cursor.insertNew(W(a)),!1}}),p={},q={},s=jb,t=document.createElement("div"),u=t.style,v={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};for(x in v)if(x in u){w=x;break}w?r=function(a,b,c){a.css(w,"scale("+b+","+c+")")}:"filter"in u?(s=function(a){a.className=a.className},r=function(a,b,c){function f(){a.css("marginRight",(d.width()-1)*(b-1)/b+"px")}var d,e;b/=1+(c-1)/2,a.css("fontSize",c+"em"),a.hasClass("matrixed-container")||a.addClass("matrixed-container").wrapInner('<span class="matrixed"></span>'),d=a.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+b+",SizingMethod='auto expand')"),f(),e=setInterval(f),db(window).load(function(){clearTimeout(e),f()})}):r=function(a,b,c){a.css("fontSize",c+"em")},y=b(i,function(a,b){a.init=function(a,c,d){b.init.call(this,a,"<"+c+" "+d+">&0</"+c+">")}}),q.mathrm=kb(y,"\\mathrm","span",'class="roman font"'),q.mathit=kb(y,"\\mathit","i",'class="font"'),q.mathbf=kb(y,"\\mathbf","b",'class="font"'),q.mathsf=kb(y,"\\mathsf","span",'class="sans-serif font"'),q.mathtt=kb(y,"\\mathtt","span",'class="monospace font"'),q.underline=kb(y,"\\underline","span",'class="non-leaf underline"'),q.overline=q.bar=kb(y,"\\overline","span",'class="non-leaf overline"'),z=b(i,function(a,b){function c(a){var b=this.parent,c=a;do{if(c.prev)return a.insertAfter(b),!1;c=c.parent.parent}while(c!==b);return a.insertBefore(b),!1}function d(a){var b=this.parent,c=a;do{if(c.next)return a.insertBefore(b),!1;c=c.parent.parent}while(c!==b);return a.insertAfter(b),!1}a.init=function(a,c,d){b.init.call(this,a,"<"+c+' class="non-leaf"><span class="non-leaf '+c+'">&0</span></'+c+">",[d])},a.finalizeTree=function(){lb("SupSub is only _ and ^",this.ctrlSeq==="^"||this.ctrlSeq==="_");if(this.prev instanceof _&&this.prev.ctrlSeq!=="\\int "){var a=this.prev,b=this.firstChild;this.ctrlSeq==="_"?(b.adopt(a,0,a.firstChild),db('<span class="from"></span>').append(b.jQ.removeClass("sub")).appendTo(a.jQ),a.down=b,b.up=c):(b.adopt(a,a.lastChild,0),db('<span class="to"></span>').append(b.jQ.removeClass("sup")).prependTo(a.jQ),a.up=b,b.down=c),this.disown(),this.respace=jb;return}this.ctrlSeq==="_"?(this.down=this.firstChild,this.firstChild.up=d):(this.up=this.firstChild,this.firstChild.down=d)},a.latex=function(){if(this.ctrlSeq==="_"&&this.respaced)return"";var a="";if(this.ctrlSeq==="^"&&this.next.respaced){var b=this.next.firstChild.latex();b.length===1?a+="_"+b:a+="_{"+b+"}"}var b=this.firstChild.latex();return b.length===1?a+=this.ctrlSeq+b:a+=this.ctrlSeq+"{"+(b||" ")+"}",a},a.redraw=function(){this.prev&&this.prev.respace(),this.prev instanceof z||(this.respace(),this.next&&!(this.next instanceof z)&&this.next.respace())},a.respace=function(){this.prev.ctrlSeq==="\\int "||this.prev instanceof z&&this.prev.ctrlSeq!=this.ctrlSeq&&this.prev.prev&&this.prev.prev.ctrlSeq==="\\int "?this["int"]||(this["int"]=!0,this.jQ.addClass("int")):this["int"]&&(this["int"]=!1,this.jQ.removeClass("int")),this.respaced=this.prev instanceof z&&this.prev.ctrlSeq!=this.ctrlSeq&&!this.prev.respaced;if(this.respaced){var a=+this.jQ.css("fontSize").slice(0,-2),b=this.prev.jQ.outerWidth(),c=this.jQ.outerWidth();this.jQ.css({left:(this["int"]&&this.ctrlSeq==="_"?-0.25:0)-b/a+"em",marginRight:.1-gb(c,b)/a+"em"})}else this["int"]&&this.ctrlSeq==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this.respaced?this.ctrlSeq==="^"?this.down=this.firstChild.down=this.prev.firstChild:this.up=this.firstChild.up=this.prev.firstChild:this.next.respaced?this.ctrlSeq==="_"?this.up=this.firstChild.up=this.next.firstChild:this.down=this.firstChild.down=this.next.firstChild:this.ctrlSeq==="_"?(delete this.up,this.firstChild.up=d):(delete this.down,this.firstChild.down=d),this.next instanceof z&&this.next.respace(),this},a.onKey=function(a,b){if(this.getCursor().parent.parent!==this)return;switch(a){case"Tab":if(this.next.respaced)return this.getCursor().prepareMove().prependTo(this.next.firstChild),b.preventDefault(),!1;break;case"Shift-Tab":if(this.respaced)return this.getCursor().prepareMove().appendTo(this.prev.firstChild),b.preventDefault(),!1;break;case"Left":if(!this.getCursor().prev&&this.respaced)return this.getCursor().prepareMove().insertBefore(this.prev),!1;break;case"Right":if(!this.getCursor().next&&this.next.respaced)return this.getCursor().prepareMove().insertAfter(this.next),!1}},a.getCursor=function(){var a;for(var b=this.parent;!a;b=b.parent)a=b.cursor;return this.getCursor=function(){return a},this.getCursor()}}),q.subscript=q._=kb(z,"_","sub","_"),q.superscript=q.supscript=q["^"]=kb(z,"^","sup","**"),A=q.frac=q.dfrac=q.cfrac=q.fraction=b(i,function(a,b){a.ctrlSeq="\\frac",a.htmlTemplate='<span class="fraction non-leaf"><span class="numerator">&0</span><span class="denominator">&1</span><span style="display:inline-block;width:0">&nbsp;</span></span>',a.textTemplate=["(","/",")"],a.finalizeTree=function(){this.up=this.lastChild.up=this.firstChild,this.down=this.firstChild.down=this.lastChild}}),B=q.over=p["/"]=b(A,function(a,b){a.createBefore=function(a){if(!this.replacedFragment){var c=a.prev;if(c instanceof K||c instanceof A)c=c.prev;else{while(c&&!(c instanceof Z||c instanceof K||c instanceof _||c instanceof A||c.ctrlSeq===","||c.ctrlSeq===":"||c.ctrlSeq==="\\space "))c=c.prev;c instanceof _&&c.next instanceof z&&(c=c.next,c.next instanceof z&&c.next.ctrlSeq!=c.ctrlSeq&&(c=c.next))}c!==a.prev&&(this.replaces(l(c.next||a.parent.firstChild,a.prev)),a.prev=c)}b.createBefore.call(this,a)}}),C=q.sqrt=q["Ú»⁄"]=b(i,function(a,b){a.ctrlSeq="\\sqrt",a.htmlTemplate='<span class="non-leaf"><span class="scaled sqrt-prefix">&radic;</span><span class="non-leaf sqrt-stem">&0</span></span>',a.textTemplate=["sqrt(",")"],a.parser=function(){return ab.optBlock.then(function(a){return ab.block.map(function(b){var c=D();return c.blocks=[a,b],a.adopt(c,0,0),b.adopt(c,a,0),c})}).or(b.parser.call(this))},a.redraw=function(){var a=this.lastChild.jQ;r(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)}}),D=q.nthroot=b(C,function(a,b){a.htmlTemplate='<sup class="nthroot non-leaf">&0</sup><span class="scaled"><span class="sqrt-prefix scaled">&radic;</span><span class="sqrt-stem non-leaf">&1</span></span>',a.textTemplate=["sqrt[","](",")"],a.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},a.onKey=function(a,b){if(this.getCursor().parent.parent!==this)return;switch(a){case"Right":if(this.getCursor().next)return;case"Tab":if(this.getCursor().parent===this.firstChild)return this.getCursor().prepareMove().prependTo(this.lastChild),b.preventDefault(),!1;break;case"Left":if(this.getCursor().prev)return;case"Shift-Tab":if(this.getCursor().parent===this.lastChild)return this.getCursor().prepareMove().appendTo(this.firstChild),b.preventDefault(),!1}},a.getCursor=z.prototype.getCursor}),E=b(i,function(a,b){a.init=function(a,c,d,e){b.init.call(this,"\\left"+d,'<span class="non-leaf"><span class="scaled paren">'+a+"</span>"+'<span class="non-leaf">&0</span>'+'<span class="scaled paren">'+c+"</span>"+"</span>",[a,c]),this.end="\\right"+e},a.jQadd=function(){b.jQadd.apply(this,arguments);var a=this.jQ;this.bracketjQs=a.children(":first").add(a.children(":last"))},a.finalizeTree=function(){if(this.firstChild.isEmpty()&&this.next){var a=l(this.next,this.parent.lastChild).disown();a.adopt(this.firstChild,0,0),a.jQ.appendTo(this.firstChild.jQ)}},a.placeCursor=function(a){a.prependTo(this.firstChild)},a.latex=function(){return this.ctrlSeq+this.firstChild.latex()+this.end},a.redraw=function(){var a=this.firstChild.jQ,b=a.outerHeight()/+a.css("fontSize").slice(0,-2);r(this.bracketjQs,gb(1+.2*(b-1),1.2),1.05*b)}}),q.left=b(i,function(a){a.parser=function(){var a,b,c,e=d.regex,f=d.string;return e=d.regex,a=d.succeed,b=ab.block,c=d.optWhitespace,c.then(e(/^(?:[([|]|\\\{)/)).then(function(b){var g;return b.charAt(0)==="\\"&&(b=b.slice(1)),g=p[b](),ab.map(function(a){g.blocks=[a],a.adopt(g,0,0)}).then(f("\\right")).skip(c).then(e(/^(?:[\])|]|\\\})/)).then(function(b){return b.slice(-1)!==g.end.slice(-1)?d.fail("open doesn't match close"):a(g)})})}}),q.right=b(i,function(a){a.parser=function(){return d.fail("unmatched \\right")}}),q.lbrace=p["{"]=kb(E,"{","}","\\{","\\}"),q.langle=q.lang=kb(E,"&lang;","&rang;","\\langle ","\\rangle "),F=b(E,function(a,b){a.createBefore=function(a){if(this.replacedFragment)return b.createBefore.call(this,a);var c=a.parent.parent;if(c.ctrlSeq===this.ctrlSeq){if(a.next){var d=l(a.next,c.firstChild.lastChild).disown();d.adopt(c.parent,c,c.next),d.jQ.insertAfter(c.jQ),a.next.respace&&a.next.respace()}a.insertAfter(c),c.bubble("redraw")}else b.createBefore.call(this,a),a.appendTo(this.firstChild)},a.finalizeTree=jb,a.placeCursor=function(a){this.firstChild.blur(),a.insertAfter(this)}}),q.rbrace=p["}"]=kb(F,"{","}","\\{","\\}"),q.rangle=q.rang=kb(F,"&lang;","&rang;","\\langle ","\\rangle "),G=function(a,b){a.init=function(a,c){b.init.call(this,a,c,a,c)}},H=b(E,G),q.lparen=p["("]=kb(H,"(",")"),q.lbrack=q.lbracket=p["["]=kb(H,"[","]"),I=b(F,G),q.rparen=p[")"]=kb(I,"(",")"),q.rbrack=q.rbracket=p["]"]=kb(I,"[","]"),J=q.lpipe=q.rpipe=p["|"]=b(H,function(a,b){a.init=function(){b.init.call(this,"|","|")},a.createBefore=function(a){!a.next&&a.parent.parent&&a.parent.parent.end===this.end&&!this.replacedFragment?a.insertAfter(a.parent.parent):i.prototype.createBefore.call(this,a)},a.finalizeTree=jb}),K=q.text=q.textnormal=q.textrm=q.textup=q.textmd=b(i,function(a,b){a.ctrlSeq="\\text",a.htmlTemplate='<span class="text">&0</span>',a.replaces=function(a){a instanceof l?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a)},a.textTemplate=['"','"'],a.parser=function(){var a=d.string,b=d.regex,c=d.optWhitespace;return c.then(a("{")).then(b(/^[^}]*/)).skip(a("}")).map(function(a){var b=K();b.createBlocks();var c=b.firstChild;for(var d=0;d<a.length;d+=1){var e=W(a.charAt(d));e.adopt(c,c.lastChild,0)}return b})},a.createBlocks=function(){this.firstChild=this.lastChild=L(),this.blocks=[this.firstChild],this.firstChild.parent=this},a.finalizeInsert=function(){this.firstChild.blur=function(){return delete this.blur,this},b.finalizeInsert.call(this)},a.createBefore=function(a){b.createBefore.call(this,this.cursor=a);if(this.replacedText)for(var c=0;c<this.replacedText.length;c+=1)this.write(this.replacedText.charAt(c))},a.write=function(a){this.cursor.insertNew(W(a))},a.onKey=function(a,b){if(!this.cursor.selection&&(a==="Backspace"&&!this.cursor.prev||a==="Del"&&!this.cursor.next))return this.isEmpty()&&this.cursor.insertAfter(this),!1},a.onText=function(a){this.cursor.prepareEdit();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(W("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=K(l(this.cursor.next,this.firstChild.lastChild));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}return this.cursor.root.triggerSpecialEvent("render"),!1}}),L=b(k,function(a,b){a.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().parent.bubble("redraw"))}return this},a.focus=function(){b.focus.call(this);var a=this.parent;if(a.next.ctrlSeq===a.ctrlSeq){var c=this,d=a.cursor,e=a.next.firstChild;e.eachChild(function(a){a.parent=c,a.jQ.appendTo(c.jQ)}),this.lastChild?this.lastChild.next=e.firstChild:this.firstChild=e.firstChild,e.firstChild.prev=this.lastChild,this.lastChild=e.lastChild,e.parent.remove(),d.prev?d.insertAfter(d.prev):d.prependTo(this),d.parent.bubble("redraw")}else if(a.prev.ctrlSeq===a.ctrlSeq){var d=a.cursor;d.prev?a.prev.firstChild.focus():d.appendTo(a.prev.firstChild)}return this}}),q.em=q.italic=q.italics=q.emph=q.textit=q.textsl=nb("\\textit","i",'class="text"'),q.strong=q.bold=q.textbf=nb("\\textbf","b",'class="text"'),q.sf=q.textsf=nb("\\textsf","span",'class="sans-serif text"'),q.tt=q.texttt=nb("\\texttt","span",'class="monospace text"'),q.textsc=nb("\\textsc","span",'style="font-variant:small-caps" class="text"'),q.uppercase=nb("\\uppercase","span",'style="text-transform:uppercase" class="text"'),q.lowercase=nb("\\lowercase","span",'style="text-transform:lowercase" class="text"'),M=b(i,function(a,b){a.ctrlSeq="\\",a.replaces=function(a){this._replacedFragment=a.disown(),this.isEmpty=function(){return!1}},a.htmlTemplate='<span class="latex-command-input non-leaf">\\<span>&0</span></span>',a.textTemplate=["\\"],a.createBlocks=function(){b.createBlocks.call(this),this.firstChild.focus=function(){return this.parent.jQ.addClass("hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("empty"),this},this.firstChild.blur=function(){return this.parent.jQ.removeClass("hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("empty"),this}},a.createBefore=function(a){b.createBefore.call(this,a),this.cursor=a.appendTo(this.firstChild);if(this._replacedFragment){var c=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(a){return db(a.target=c).trigger(a),!1}).insertBefore(this.jQ).add(this.jQ)}},a.latex=function(){return"\\"+this.firstChild.latex()+" "},a.onKey=function(a,b){if(a==="Tab"||a==="Enter")return this.renderCommand(),this.cursor.root.triggerSpecialEvent("render"),b.preventDefault(),!1},a.onText=function(a){if(a.match(/[a-z]/i))return this.cursor.prepareEdit(),this.cursor.insertNew(W(a)),!1;this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return this.cursor.root.triggerSpecialEvent("render"),!1},a.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;a||(a="backslash"),this.cursor.insertCmd(a,this._replacedFragment)}}),N=q.binom=q.binomial=b(i,function(a,b){a.ctrlSeq="\\binom",a.htmlTemplate='<span class="paren scaled">(</span><span class="non-leaf"><span class="array non-leaf"><span>&0</span><span>&1</span></span></span><span class="paren scaled">)</span>',a.textTemplate=["choose(",",",")"],a.redraw=function(){var a=this.jQ.eq(1),b=a.outerHeight()/+a.css("fontSize").slice(0,-2),c=this.jQ.filter(".paren");r(c,gb(1+.2*(b-1),1.2),1.05*b)}}),O=q.choose=b(N,function(a){a.createBefore=B.prototype.createBefore}),P=q.vector=b(i,function(a,b){a.ctrlSeq="\\vector",a.htmlTemplate='<span class="array"><span>&0</span></span>',a.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){return a.push(b.latex()),a}).join("\\\\")+"\\end{matrix}"},a.text=function(){return"["+this.foldChildren([],function(a,b){return a.push(b.text()),a}).join()+"]"},a.createBefore=function(a){b.createBefore.call(this,this.cursor=a)},a.onKey=function(a,b){var c=this.cursor.parent;if(c.parent===this){if(a==="Enter"){var d=k();return d.parent=this,d.jQ=db("<span></span>").attr(fb,d.id).insertAfter(c.jQ),c.next?c.next.prev=d:this.lastChild=d,d.next=c.next,c.next=d,d.prev=c,this.bubble("redraw").cursor.appendTo(d),b.preventDefault(),!1}if(a==="Tab"&&!c.next){if(c.isEmpty()){if(c.prev)return this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.bubble("redraw"),b.preventDefault(),!1;return}var d=k();return d.parent=this,d.jQ=db("<span></span>").attr(fb,d.id).appendTo(this.jQ),this.lastChild=d,c.next=d,d.prev=c,this.bubble("redraw").cursor.appendTo(d),b.preventDefault(),!1}if(b.which===8){if(c.isEmpty())return c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),b.preventDefault(),!1;if(!this.cursor.prev)return b.preventDefault(),!1}}}}),Q=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,"<var>"+(c||a)+"</var>")},a.createBefore=function(a){var c=this.ctrlSeq;for(var d=0,e=a.prev;d<V-1&&e&&e instanceof Q;d+=1,e=e.prev)c=e.ctrlSeq+c;while(c.length){if(U.hasOwnProperty(c)){for(var d=1;d<c.length;d+=1)a.backspace();a.insertNew(q[c](c));return}c=c.slice(1)}b.createBefore.apply(this,arguments)},a.respace=a.finalizeTree=function(){var a=this.ctrlSeq;if(a.length>1)return;for(var b=this.prev;b instanceof Q&&b.ctrlSeq.length===1;b=b.prev)a=b.ctrlSeq+a;for(var c=this.next;c instanceof Q&&c.ctrlSeq.length===1;c=c.next)a+=c.ctrlSeq;l(b.next||this.parent.firstChild,c.prev||this.parent.lastChild).each(function(a){a.jQ.removeClass("un-italicized last"),delete a.isFirstLetter,delete a.isLastLetter});a:for(var d=0,e=b.next||this.parent.firstChild;d<a.length;d+=1,e=e.next)for(var f=gb(T,a.length-d);f>0;f-=1)if(S.hasOwnProperty(a.slice(d,d+f))){e.isFirstLetter=!0;for(var g=0,h=e;g<f;g+=1,h=h.next){h.jQ.addClass("un-italicized");var i=h}i.isLastLetter=!0,i.next instanceof z||i.next instanceof E||i.jQ.addClass("last"),d+=f-1,e=i;continue a}},a.latex=function(){return this.isFirstLetter?"\\"+this.ctrlSeq:this.isLastLetter?this.ctrlSeq+" ":this.ctrlSeq},a.text=function(){var a=this.ctrlSeq;return this.prev&&!(this.prev instanceof Q)&&!(this.prev instanceof Z)&&(a="*"+a),this.next&&!(this.next instanceof Z)&&this.next.ctrlSeq!=="^"&&(a+="*"),a}}),R=b(j,function(a,b){a.init=function(a){this.ctrlSeq=a},a.createBefore=function(a){a.writeLatex(this.ctrlSeq).show()},a.parser=function(){var a=this.ctrlSeq,b=k();for(var c=0;c<a.length;c+=1)Q(a.charAt(c)).adopt(b,b.lastChild,0);return d.succeed(b.children())}}),S={ln:1,log:1,min:1,nCr:1,nPr:1,gcd:1,lcm:1,ceil:1,exp:1,abs:1,max:1,mod:1,lcm:1,gcd:1,gcf:1,hcf:1,exp:1,floor:1,sign:1,round:1},T=9,U={sqrt:1,nthroot:1,sum:1,prod:1,pi:1,theta:1},V=7,function(){var a,b,c={sin:1,cos:1,tan:1,sec:1,cosec:1,csc:1,cotan:1,cot:1,ctg:1};for(a in c)S[a]=S["arc"+a]=S[a+"h"]=S["arc"+a+"h"]=1;for(b in S)q[b]=R}(),W=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,"<span>"+(c||a)+"</span>")}}),p[" "]=kb(W,"\\space "," "),q.prime=p["'"]=kb(W,"'","&prime;"),X=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,'<span class="nonSymbola">'+(c||a)+"</span>")}}),q["@"]=X,q["&"]=kb(X,"\\&","&amp;"),q["%"]=kb(X,"\\%","%"),q.alpha=q.beta=q.gamma=q.delta=q.zeta=q.eta=q.theta=q.iota=q.kappa=q.mu=q.nu=q.xi=q.rho=q.sigma=q.tau=q.chi=q.psi=q.omega=b(Q,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),q.phi=kb(Q,"\\phi ","&#981;"),q.phiv=q.varphi=kb(Q,"\\varphi ","&phi;"),q.epsilon=kb(Q,"\\epsilon ","&#1013;"),q.epsiv=q.varepsilon=kb(Q,"\\varepsilon ","&epsilon;"),q.piv=q.varpi=kb(Q,"\\varpi ","&piv;"),q.sigmaf=q.sigmav=q.varsigma=kb(Q,"\\varsigma ","&sigmaf;"),q.thetav=q.vartheta=q.thetasym=kb(Q,"\\vartheta ","&thetasym;"),q.upsilon=q.upsi=kb(Q,"\\upsilon ","&upsilon;"),q.gammad=q.Gammad=q.digamma=kb(Q,"\\digamma ","&#989;"),q.kappav=q.varkappa=kb(Q,"\\varkappa ","&#1008;"),q.rhov=q.varrho=kb(Q,"\\varrho ","&#1009;"),q.pi=q["?¿"]=kb(X,"\\pi ","&pi;"),q.theta=q["??"]=kb(X,"\\theta ","&theta;"),q.lambda=kb(X,"\\lambda ","&lambda;"),q.Upsilon=q.Upsi=q.upsih=q.Upsih=kb(j,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),q.Gamma=q.Delta=q.Theta=q.Lambda=q.Xi=q.Pi=q.Sigma=q.Phi=q.Psi=q.Omega=q.forall=b(W,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),Y=b(i,function(a){a.init=function(a){this.latex=a},a.createBefore=function(a){a.writeLatex(this.latex)},a.parser=function(){var a=ab.parse(this.latex).children();return d.succeed(a)}}),q["??"]=kb(Y,"^1"),q["??"]=kb(Y,"^2"),q["??"]=kb(Y,"^3"),q["??"]=kb(Y,"\\frac14"),q["??"]=kb(Y,"\\frac12"),q["??"]=kb(Y,"\\frac34"),Z=b(j,function(a,b){a.init=function(a,c,d){b.init.call(this,a,'<span class="binary-operator">'+c+"</span>",d)},a.createBefore=function(a){var c=a.prev.ctrlSeq+this.ctrlSeq;c==="<="?a.backspace().insertNew(Z("\\le ","&le;")):c===">="?a.backspace().insertNew(Z("\\ge ","&ge;")):b.createBefore.apply(this,arguments)}}),$=b(Z,function(a){a.init=W.prototype.init,a.respace=function(){return this.prev?this.prev instanceof Z&&this.next&&!(this.next instanceof Z)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="",this}}),q["+"]=kb($,"+","+"),q["Ú¿”"]=q["-"]=kb($,"-","&minus;"),q["??"]=q.pm=q.plusmn=q.plusminus=kb($,"\\pm ","&plusmn;"),q.mp=q.mnplus=q.minusplus=kb($,"\\mp ","&#8723;"),p["*"]=q.sdot=q.cdot=kb(Z,"\\cdot ","&middot;"),q["="]=kb(Z,"=","="),q["<"]=kb(Z,"<","&lt;"),q[">"]=kb(Z,">","&gt;"),q.notin=q.sim=q.cong=q.equiv=q.oplus=q.otimes=b(Z,function(a,b){a.init=function(a){b.init.call(this,"\\"+a+" ","&"+a+";")}}),q.times=kb(Z,"\\times ","&times;","[x]"),q["??"]=q.div=q.divide=q.divides=kb(Z,"\\div ","&divide;","[/]"),q["Ú… "]=q.ne=q.neq=kb(Z,"\\ne ","&ne;"),q.ast=q.star=q.loast=q.lowast=kb(Z,"\\ast ","&lowast;"),q.therefor=q.therefore=kb(Z,"\\therefore ","&there4;"),q.cuz=q.because=kb(Z,"\\because ","&#8757;"),q.prop=q.propto=kb(Z,"\\propto ","&prop;"),q["Ú…»"]=q.asymp=q.approx=kb(Z,"\\approx ","&asymp;"),q.lt=kb(Z,"<","&lt;"),q.gt=kb(Z,">","&gt;"),q["Ú…‰"]=q.le=q.leq=kb(Z,"\\le ","&le;"),q["Ú…Â"]=q.ge=q.geq=kb(Z,"\\ge ","&ge;"),q.isin=q["in"]=kb(Z,"\\in ","&isin;"),q.ni=q.contains=kb(Z,"\\ni ","&ni;"),q.notni=q.niton=q.notcontains=q.doesnotcontain=kb(Z,"\\not\\ni ","&#8716;"),q.sub=q.subset=kb(Z,"\\subset ","&sub;"),q.sup=q.supset=q.superset=kb(Z,"\\supset ","&sup;"),q.nsub=q.notsub=q.nsubset=q.notsubset=kb(Z,"\\not\\subset ","&#8836;"),q.nsup=q.notsup=q.nsupset=q.notsupset=q.nsuperset=q.notsuperset=kb(Z,"\\not\\supset ","&#8837;"),q.sube=q.subeq=q.subsete=q.subseteq=kb(Z,"\\subseteq ","&sube;"),q.supe=q.supeq=q.supsete=q.supseteq=q.supersete=q.superseteq=kb(Z,"\\supseteq ","&supe;"),q.nsube=q.nsubeq=q.notsube=q.notsubeq=q.nsubsete=q.nsubseteq=q.notsubsete=q.notsubseteq=kb(Z,"\\not\\subseteq ","&#8840;"),q.nsupe=q.nsupeq=q.notsupe=q.notsupeq=q.nsupsete=q.nsupseteq=q.notsupsete=q.notsupseteq=q.nsupersete=q.nsuperseteq=q.notsupersete=q.notsuperseteq=kb(Z,"\\not\\supseteq ","&#8841;"),_=b(j,function(a,b){a.init=function(a,c){b.init.call(this,a,'<span class="large-operator non-leaf"><big>'+c+"</big></span>"),a!=="\\int "&&(this.placeCursor=function(a){a.writeLatex("^{}_{n=}").appendTo(this.firstChild).show()})},a.isEmpty=i.prototype.isEmpty,a.latex=function(){function c(a){return a.length===1?a:"{"+(a||" ")+"}"}var a=this.firstChild?"_"+c(this.firstChild.latex()):"",b=this.lastChild?"^"+c(this.lastChild.latex()):"";return this.ctrlSeq+a+b}}),q["Ú»—"]=q.sum=q.summation=kb(_,"\\sum ","&sum;"),q["Ú»œ"]=q.prod=q.product=kb(_,"\\prod ","&prod;"),q.coprod=q.coproduct=kb(_,"\\coprod ","&#8720;"),q["Ú»Î"]=q["int"]=q.integral=b(_,function(a){a.init=function(){j.prototype.init.call(this,"\\int ","<big>&int;</big>")}}),q.space=kb(W,"\\space ","&nbsp;"),q.and=q.land=q.wedge=kb(W,"\\wedge ","&and;"),q.or=q.lor=q.vee=kb(W,"\\vee ","&or;"),ab=function(){function a(a){var b=k();return a.adopt(b,0,0),b}function b(a){var b=a[0]||k();for(var c=1;c<a.length;c+=1)a[c].children().adopt(b,b.lastChild,0);return b}var c=d.string,e=d.regex,f=d.letter,g=d.any,h=d.optWhitespace,i=d.succeed,j=d.fail,l=f.map(Q),m=e(/^[^${}\\_^]/).map(W),n=e(/^[^\\]/).or(c("\\").then(e(/^[a-z]+/i).or(e(/^\s+/).result(" ")).or(g))).then(function(a){var b=q[a];return b?b(a).parser():j("unknown command: \\"+a)}),o=n.or(l).or(m),p=c("{").then(function(){return s}).skip(c("}")),r=h.then(p.or(o.map(a))),s=r.many().map(b).skip(h),t=c("[").then(r.then(function(a){return a.join("latex")!=="]"?i(a):j()}).many().map(b).skip(h)).skip(c("]")),u=s;return u.block=r,u.optBlock=t,u}(),bb=b(function(a){function b(a,b){if(a.next[b])a.prependTo(a.next[b]);else if(a.prev[b])a.appendTo(a.prev[b]);else{var d=a.parent;do{var e=d[b];if(e){typeof e=="function"&&(e=d[b](a));if(e===!1||e instanceof k){a.upDownCache[d.id]={parent:a.parent,prev:a.prev,next:a.next};if(e instanceof k){var f=a.upDownCache[e.id];if(f)f.next?a.insertBefore(f.next):a.appendTo(f.parent);else{var g=c(a).left;a.appendTo(e),a.seekHoriz(g,e)}}break}}d=d.parent.parent}while(d)}return a.clearSelection().show()}function c(a){var b=a.jQ.removeClass("cursor").offset();return a.jQ.addClass("cursor"),b}function e(a){a.upDownCache={}}a.init=function(a){this.parent=this.root=a;var b=this.jQ=this._jQ=db('<span class="cursor">&zwj;</span>');this.blink=function(){b.toggleClass("blink")},this.upDownCache={}},a.prev=0,a.next=0,a.parent=0,a.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.first.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},a.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=db(),this},a.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.prev=b,this.next=c,d.blur()},a.insertBefore=function(a){return this.insertAt(a.parent,a.prev,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first()),this},a.insertAfter=function(a){return this.insertAt(a.parent,a,a.next),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last()),this},a.prependTo=function(a){return this.insertAt(a,0,a.firstChild),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus(),this},a.appendTo=function(a){return this.insertAt(a,a.lastChild,0),this.jQ.appendTo(a.jQ),a.focus(),this},a.hopLeft=function(){return this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev,this},a.hopRight=function(){return this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next,this},a.moveLeftWithin=function(a){this.prev?this.prev instanceof D?this.appendTo(this.prev.lastChild):this.prev.up instanceof k?this.appendTo(this.prev.up):this.prev.firstChild?this.appendTo(this.prev.firstChild):this.hopLeft():this.parent!==a?this.insertBefore(this.parent.parent):a.moveOutOf&&a.moveOutOf("left",this)},a.moveRightWithin=function(a){this.next?this.next.up instanceof k?this.prependTo(this.next.up):this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent!==a?this.insertAfter(this.parent.parent):a.moveOutOf&&a.moveOutOf("right",this)},a.moveLeft=function(){return e(this),this.selection?this.insertBefore(this.selection.first).clearSelection():this.moveLeftWithin(this.root),this.root.triggerSpecialEvent("cursorMoved"),this.show()},a.moveRight=function(){return e(this),this.selection?this.insertAfter(this.selection.last).clearSelection():this.moveRightWithin(this.root),this.root.triggerSpecialEvent("cursorMoved"),this.show()},a.moveUp=function(){return b(this,"up")},a.moveDown=function(){return b(this,"down")},a.seek=function(a,b,c){e(this);var d,f,g=this.clearSelection().show();return f=h[a.attr(fb)],f&&a.hasClass("empty")?(g.prependTo(f),g):(d=h[a.attr(eb)],d instanceof j?(a.outerWidth()>2*(b-a.offset().left)?g.insertBefore(d):g.insertAfter(d),g):(!d&&!f&&(a=a.parent(),d=h[a.attr(eb)],d||(f=h[a.attr(fb)],f||(f=g.root))),d?g.insertAfter(d):g.appendTo(f),g.seekHoriz(b,g.root)))},a.seekHoriz=function(a,b){var d=this,e=c(d).left-a,f;while(e>0&&(d.prev||d.parent!==b))!d.prev&&d.parent.parent.respaced?d.appendTo(d.parent.parent.prev.firstChild):d.moveLeftWithin(b),f=e,e=c(d).left-a;return-e>f&&d.moveRightWithin(b),d},a.writeLatex=function(a){var b=this;e(b),b.show().deleteSelection();var c=d.all,f=d.eof,g=ab.skip(f).or(c.result(!1)).parse(a);return g&&(g.children().adopt(b.parent,b.prev,b.next),h.jQize(g.join("html")).insertBefore(b.jQ),b.prev=g.lastChild,g.finalizeInsert(),b.parent.bubble("redraw")),this},a.write=function(a){return e(this),this.show().insertCh(a)},a.insertCh=function(a){var b;return a.match(/^[a-z]$/i)?b=Q(a):(b=p[a]||q[a])?b=b(a):b=W(a),this.selection&&(this.prev=this.selection.first.prev,this.next=this.selection.last.next,b.replaces(this.selection),delete this.selection),this.insertNew(b)},a.insertNew=function(a){return a.createBefore(this),this},a.insertCmd=function(a,b){var c=q[a];return c?(c=c(a),b&&c.replaces(b),this.insertNew(c)):(c=K(),c.replaces(a),c.firstChild.focus=function(){return delete this.focus,this},this.insertNew(c).insertAfter(c),b&&b.remove()),this},a.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.next,d=this,e=a.prev;a.disown().eachChild(function(d){if(d.isEmpty())return;d.children().adopt(b,e,c).each(function(b){b.jQ.insertBefore(a.jQ.first())}),e=d.lastChild});if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(!this.parent){this.next=a.next,this.parent=b;break}this.next=this.parent.firstChild}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},a.backspace=function(){e(this),this.show();if(!this.deleteSelection())if(this.prev)if(this.prev.isEmpty()){if(this.prev.ctrlSeq==="\\le ")var a=q["<"]("<");else if(this.prev.ctrlSeq==="\\ge ")var a=q[">"](">");this.prev=this.prev.remove().prev,a&&this.insertNew(a)}else{if(this.prev instanceof E)return this.appendTo(this.prev.firstChild).deleteForward();this.selectLeft()}else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();if(this.next instanceof E)return this.prependTo(this.next.firstChild).backspace();this.unwrapGramp()}else this.root.triggerSpecialEvent("backspacePressed");return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw"),this},a.deleteForward=function(){e(this),this.show();if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}else this.root.triggerSpecialEvent("delPressed");return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw"),this},a.selectFrom=function(a){var b=this,c=a;a:for(;;){for(var d=this;d!==b.parent.parent;d=d.parent.parent)if(d.parent===c.parent){f=d,g=c;break a}for(var e=a;e!==c.parent.parent;e=e.parent.parent)if(b.parent===e.parent){f=b,g=e;break a}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var f,g,h;if(f.next!==g){for(var i=f;i;i=i.next)if(i===g.prev){h=!0;break}h||(h=g,g=f,f=h)}this.hide().selection=cb(f.prev.next||f.parent.firstChild,g.next.prev||g.parent.lastChild),this.insertAfter(g.next.prev||g.parent.lastChild),this.root.selectionChanged()},a.selectLeft=function(){e(this);if(this.selection)if(this.selection.first===this.next)this.prev?this.hopLeft().selection.extendLeft():this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp();else{this.hopLeft();if(this.selection.first===this.selection.last){this.clearSelection().show();return}this.selection.retractLeft()}else{if(this.prev)this.hopLeft();else{if(this.parent===this.root)return;this.insertBefore(this.parent.parent)}this.hide().selection=cb(this.next)}this.root.selectionChanged()},a.selectRight=function(){e(this);if(this.selection)if(this.selection.last===this.prev)this.next?this.hopRight().selection.extendRight():this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp();else{this.hopRight();if(this.selection.first===this.selection.last){this.clearSelection().show();return}this.selection.retractRight()}else{if(this.next)this.hopRight();else{if(this.parent===this.root)return;this.insertAfter(this.parent.parent)}this.hide().selection=cb(this.prev)}this.root.selectionChanged()},a.prepareMove=function(){return e(this),this.show().clearSelection()},a.prepareEdit=function(){return e(this),this.show().deleteSelection()},a.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},a.deleteSelection=function(){return this.selection?(this.prev=this.selection.first.prev,this.next=this.selection.last.next,this.selection.remove(),this.root.selectionChanged(),delete this.selection):!1}}),cb=b(l,function(a,b){a.init=function(){var a=this;b.init.apply(a,arguments),a.jQwrap(a.jQ)},a.jQwrap=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},a.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),b.adopt.apply(this,arguments)},a.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},a.levelUp=function(){var a=this,b=a.first=a.last=a.last.parent.parent;return a.clear().jQwrap(b.jQ),a},a.extendLeft=function(){this.first=this.first.prev,this.first.jQ.prependTo(this.jQ)},a.extendRight=function(){this.last=this.last.next,this.last.jQ.appendTo(this.jQ)},a.retractRight=function(){this.first.jQ.insertBefore(this.jQ),this.first=this.first.next},a.retractLeft=function(){this.last.jQ.insertAfter(this.jQ),this.last=this.last.prev}}),db.fn.onsolver=function(a,b){var c,d,e,f,g,i;switch(a){case"focus":case"blur":return this.each(function(){var b=db(this).attr(fb),c=b&&h[b];c&&c.textarea&&c.textarea.children().trigger(a)});case"onKey":case"onText":return this.each(function(){var c=db(this).attr(fb),d=c&&h[c],e=d&&d.cursor;e&&(e.parent.bubble(a,b,{preventDefault:jb}),d.blurred&&e.hide().parent.blur())});case"redraw":return this.each(function(){var a=db(this).attr(fb),b=a&&h[a];b&&function c(a){a.eachChild(c),a.redraw&&a.redraw()}(b)});case"revert":return this.each(function(){var a=db(this).attr(fb),b=a&&h[a];b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var a=db(this).attr(fb),c=a&&h[a];c&&(c.renderLatex(b),c.blurred&&c.cursor.hide().parent.blur(),c.triggerSpecialEvent("render"))});return c=db(this).attr(fb),d=c&&h[c],d&&d.latex();case"text":return c=db(this).attr(fb),d=c&&h[c],d&&d.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var a=db(this).attr(fb),c=a&&h[a],d=c&&c.cursor;d&&(d.writeLatex(b),c.blurred&&d.hide().parent.blur())});case"cmd":if(arguments.length>1)return this.each(function(){var a,c=db(this).attr(fb),d=c&&h[c],e=d&&d.cursor;e&&(e.show(),/^\\[a-z]+$/i.test(b)?(a=e.selection,a&&(e.prev=a.first.prev,e.next=a.last.next,delete e.selection),e.insertCmd(b.slice(1),a)):e.insertCh(b),d.blurred&&e.hide().parent.blur())});case"moveStart":c=db(this).attr(fb),d=c&&h[c],d&&d.cursor&&d.cursor.prependTo(d);break;case"moveEnd":c=db(this).attr(fb),d=c&&h[c],d&&d.cursor&&d.cursor.appendTo(d);break;case"selection":c=db(this).attr(fb),d=c&&h[c],e=d&&d.cursor;if(!e)return;return e.selection?"$"+e.selection.latex()+"$":"";case"clearSelection":return this.each(function(){var a=db(this).attr(fb),b=a&&h[a],c=b&&b.cursor;c&&(c.clearSelection(),b.blurred&&c.hide().parent.blur())});default:return f=a==="textbox",g=f||a==="editable",i=f?o:m,this.each(function(){mb(db(this),i(),f,g)})}};db(function(){db(".onsolver-editable:not(.onsolver-rendered-math)").onsolver("editable"),db(".onsolver-textbox:not(.onsolver-rendered-math)").onsolver("textbox"),db(".onsolver-embedded-latex").onsolver()})})();
